    function cmenu = AddLineContextMenu(DATA, h)        if ~isfield(DATA,'CellList')            cmenu = [];            return;        end                h = h(h>0);        p = AllV.ProbeNumber(DATA);        eid = [];        if isfield(DATA,'CellDetails') && isfield(DATA.CellDetails,'exptids')            eid = find(DATA.CellDetails.exptids == DATA.exptno);        else            eid = DATA.exptno;        end        %if > 1 expts in list, check for cells defined on this probe in adjacent expts                if ~isempty(eid) && eid <= size(DATA.CellList,1)            ecells = squeeze(DATA.CellList(eid,:,:));        else            ecells = [];        end        pcells = squeeze(DATA.CellList(:,p,:));        pid = find(sum(pcells,2) > 0);  %probes with defined cells        if isempty(pid) || isempty(eid) || size(DATA.CellList,1) == 1            nearestex = 0;            nearestcell = 0;        else            [a,b] = min(abs(eid-pid));            nearestex = pid(b); %nearest expt with this probe defined as cell            nearestcell = DATA.CellList(nearestex,p,:);        end        eid = find(DATA.CellDetails.exptids == DATA.exptno);    for j = 2:length(h)        cmenu = uicontextmenu;        if isempty(eid)            k = 0        elseif j > size(DATA.CellList,3)+1 || eid > size(DATA.CellList,1)            k = 0;        else            k = DATA.CellList(eid,DATA.probe(1),j-1);        end        if k > 0            uimenu(cmenu,'label',sprintf('Spike%d Cell%d',j-1,k),'foregroundcolor',get(h(j),'color'));            c = uimenu(cmenu,'label','clear','Callback',{@DeleteCellFromLine, j-1,  k});        else            uimenu(cmenu,'label',sprintf('Spike%d',j-1),'foregroundcolor',get(h(j),'color'));        end        ccolor = get(h(j),'color');        if size(ecells,2) >= j-1 && size(ecells,1) >= p        ccell = ecells(p,j-1);        else            ccell = 0;        end        for k = 1:30            c = uimenu(cmenu,'label',sprintf('Cell %d',k),'Callback',{@AllV.SetCellFromLine, j-1,  k});            if k == 1                set(c,'separator','on');            end            if k == ccell                set(c,'foregroundcolor',ccolor)            elseif sum(ecells(:) == k) %this cell already defined                set(c,'foregroundcolor',[0 0.8 0])            elseif ismember(k,nearestcell)                cl = find(nearestcell == k);                set(c,'label',sprintf('Cell %d (E%d)',k,nearestex),'foregroundcolor',DATA.colors{cl+1});            end                        end        set(h(j),'uicontextmenu',cmenu);    end