function [AllVoltages, DATA] = BuildAllV(DATA, id, spts, varargin)setdata = 1;j = 1;while j <= length(varargin)    if strncmp(varargin{j},'noset',5)        setdata = 0;    end    j = j+1;end    V = AllV.mygetappdata(DATA,'Vall');    allid = repmat(id,length(spts),1) + repmat(spts',1,length(id));    if isappdata(DATA.toplevel,'AllInts')        Vi = getappdata(DATA.toplevel, 'AllInts');        AllVoltages = reshape(Vi(:,allid),[size(Vi,1) size(allid)]);    else        AllVoltages = reshape(V.V(:,allid),[size(V.V,1) size(allid)]);    end    if isinteger(AllVoltages)        AllVoltages = double(AllVoltages) .* V.intscale(1)/V.intscale(2);    end    if setdata    DATA = AllV.mysetappdata(DATA,'AllVoltages',AllVoltages);    end    if isfield(V,'meanV')        DATA.meanV = V.meanV(allid);        if setdata            DATA = AllV.mysetappdata(DATA,'MeanV',DATA.meanV);        end        if DATA.addmean            if isfield(V,'sumscale') && length(Vall.sumscale) >= j                meanscale = V.sumscale(j);            elseif isfield(V,'meangain') && length(Vall.meangain) >= j                meanscale = V.meangain(j);            else                meanscale = 1;            end            for j = 1:size(AllVoltages,1)                AllVoltages(j,:,:) = squeeze(AllVoltages(j,:,:)) + DATA.meanV.*meanscale;            end        end    end    if setdata    DATA.energy = [];    DATA.spkvar = [];    DATA.energy(1,:) = sqrt(squeeze(sum(diff(AllVoltages(DATA.probe(1),:,:),1,2).^2,2)));    DATA.spkvar(DATA.probe(1),:) = squeeze(std(AllVoltages(DATA.probe(1),:,:),[],2));    DATA.nevents = size(AllVoltages,3);    end