function [MeanSpike, details] = PlotMeanSpike(DATA, varargin)%MeanSpike = PlotMeanSpike(DATA, varargin)%Calculate/plot mean spike waveform for cluster 1%PlotMeanSpike(DATA, 'cluster', n) to caclulate cluster n (clst == n+1)    recalc = 0;    noplot = 0;    clnum = DATA.currentcluster;        tlist = 1;    j = 1;    while j <= length(varargin)        if strncmpi(varargin{j},'cluster',4)            j = j+1;            clnum = varargin{j};        elseif strncmpi(varargin{j},'noplot',4)            noplot = 1;        elseif strncmpi(varargin{j},'recalc',4)            recalc = 1;        end        j = j+1;    end    id = find(DATA.clst == clnum+1);    nid = find(DATA.clst == 1);    if isempty(id) && sum(DATA.clst >1) ==0        fprintf('No Spikes to calucalte MeanSpike. Using Energy\n');        pe = find(DATA.eprobe == DATA.probe(1));        if pe > size(DATA.energy,1)            pe = size(DATA.energy,1);        end        crit = prctile(DATA.energy(pe,:),90);        id = find(DATA.energy(pe,:) >= crit);        nid = find(DATA.energy(pe,:) < crit);    end    details.id = id;    details.nid = nid;    MeanSpike.addmean = DATA.addmean;    if strcmp(DATA.plot.meantype,'allclusters')        for j = 1:length(DATA.cluster.next)            if isfield(DATA.cluster.next{j},'MeanSpike')                tlist = [tlist j+1];            end        end    end    if DATA.interactive >= 0        AllV.SetFigure(DATA.tag.meanspike, DATA);        subplot(length(tlist),2,1);        hold off;    end    AllVoltages = AllV.mygetappdata(DATA,'AllVoltages');    MeanV = AllV.mygetappdata(DATA,'MeanV');    if DATA.keepsmooth && ~isempty(id)        lfpts = -20000:10:20000;        sampleid = DATA.trigtimes{1}(id);        samplenid = DATA.trigtimes{1}(nid);        Vall = AllV.mygetappdata(DATA,'Vall');        allid = RectAdd(lfpts, sampleid, 'range', [1 length(Vall.Vsmooth)]);        MeanSpike.lfpmean = mean(Vall.Vsmooth(allid)+double(Vall.V(allid)),1);        [st, tid] = ShuffleTimes(Vall.t(sampleid),DATA.Expt);        sid  = FullVTimes2id(Vall,st);        allid = RectAdd(lfpts, sid, 'range', [1 length(Vall.Vsmooth)]);        MeanSpike.shufflemean = mean(Vall.Vsmooth(allid)+double(Vall.V(allid)),1);        muid = RectAdd(lfpts, samplenid, 'range', [1 length(Vall.Vsmooth)]);        MeanSpike.lfpumean = mean(Vall.Vsmooth(muid)+double(Vall.V(muid)),1);    end    if ~isfield(DATA,'MeanSpike') || recalc        ms = mean(AllVoltages(:,:,id),3);        mu = mean(AllVoltages(:,:,nid),3);        if DATA.loadfromspikes == 0 %cant dot his here - other probes done have mean subtracted                MeanSpike.addmean =0;        elseif DATA.addmean == 0  %if 1, already added to AllVoltages            if size(MeanV,2) == size(AllVoltages,3)                mum = mean(MeanV(:,nid)');                msm = mean(MeanV(:,id)');                                if isfield(DATA.meanvdata,'meangain')                    mscale = DATA.meanvdata.meangain;                else                    mscale = ones(1,DATA.nprobes);                end                for j = 1:DATA.nprobes                    ms(j,:) = ms(j,:) + msm .*mscale(j);                    mu(j,:) = mu(j,:) + mum .* mscale(j);                end                MeanSpike.addmean = 1;  %has been added back in to the mean            else                MeanSpike.addmean =0;            end        end        MeanSpike.ms = ms;        MeanSpike.mu = mu;        xc = corrcoef(ms(:),mu(:));        MeanSpike.muxc = xc(1,2);    else        if isfield(DATA.cluster,'MeanSpike') && isfield(DATA.cluster.MeanSpike,'ms')            ms = DATA.cluster.MeanSpike.ms;            mu = DATA.cluster.MeanSpike.mu;        else            ms = DATA.MeanSpike.ms;            mu = DATA.MeanSpike.mu;            DATA.cluster.MeanSpike.ms = ms;            DATA.cluster.MeanSpike.mu = mu;        end        MeanSpike.ms = ms;        MeanSpike.mu = mu;    end    MeanSpike.amp = std(MeanSpike.ms');        %Cacluldate vdprime even if non-interactive%this needed some kludges. Not sure if works propefly for%cluster 2 etc. cf. using DATA.Cluster.Meanspike below%Used MeanSpike just to get this to work    chspk = DATA.chspk;    for p = 1:length(tlist)        subplot(length(tlist),2,p*2);        if tlist(p) == clnum            mspk = ms;            muspk = mu;        elseif tlist(p) ==1            mspk = MeanSpike.ms;            muspk = MeanSpike.mu;        else            mspk = MeanSpike.ms;            muspk = MeanSpike.mu;        end                for j = chspk            if DATA.plotdvdt && DATA.plotcsd                dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(diff(csd(j,:,id),1,2),[],3) var(diff(csd(j,:,nid),1,2),[],3)]));            elseif DATA.plotdvdt                dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(diff(AllVoltages(j,:,nid),1,2),[],3) var(diff(AllVoltages(j,:,id),1,2),[],3)]));            elseif DATA.plotcsd                dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(csd(j,:,id),[],3) var(csd(j,:,nid),[],3)]));            else                dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(AllVoltages(j,:,nid),[],3) var(AllVoltages(j,:,id),[],3)]));            end            dpscale = max(mspk(:))./max(dp);            if recalc                MeanSpike.vdprime(j,:) = dp;            end        end    end    if noplot        return;    end    dj = 0;%do csd first, then can do dvdt to CSD     if DATA.plotcsd       ms = (diff(ms,2,1));       mu = (diff(mu,2,1));       csd = diff(AllVoltages,DATA.plotcsd,1);        chspk = chspk-1;        dj = 1;    end    if DATA.plotdvdt       ms = (diff(ms,1,2));       mu = (diff(mu,1,2));    end    if DATA.interactive >= 0        if DATA.plot.comparemean > 0            C = AllV.mygetappdata(DATA,'Clusters');            imagesc([1 size(ms,2)],[1 size(ms,1)],ms);            title(sprintf('P%d Cl %d',DATA.probe(1),clnum));            subplot(1,2,2);            hold off;            msa = C{DATA.plot.comparemean}.MeanSpike.ms;            imagesc([1 size(msa,2)],[1 size(msa,1)],msa);            title(sprintf('P%d Cl %d',DATA.plot.comparemean,1));            return;        elseif strcmp(DATA.plot.meantype,'sidebyside')            imagesc([1 size(ms,2)],[1 size(ms,1)-2],ms(1:2:end,:));            subplot(1,2,2);            hold off;            imagesc([1 size(ms,2)],[2 size(ms,1)-1],ms(2:2:end,:));            return;        else            for j = 1:length(tlist)                subplot(length(tlist),2,(j*2)-1);                if tlist(j) == clnum                    imagesc(ms);                elseif tlist(j) == 1 && isfield(DATA.cluster,'MeanSpike')                    imagesc(DATA.cluster.MeanSpike.ms);                elseif tlist(j) > 1                    imagesc(DATA.cluster.next{tlist(j)-1}.MeanSpike.ms);                end            end        end        for j = 1:length(DATA.triggerchan)            p = DATA.triggerchan(j);            xl = get(gca,'xlim');            line([xl(1) xl(2)/5],[p p ],'color','k');        end    title(sprintf('P%d Cl %d',DATA.probe(1),clnum));    if size(AllVoltages,1)  == 1        if DATA.keepsmooth && isfield(MeanSpike,'lfpmean')            subplot(2,1,2);            hold off;            plot(MeanSpike.lfpmean);            hold on;            plot(get(gca,'xlim'),[0 0],'k:');            plot(MeanSpike.lfpumean,'g');            plot(MeanSpike.shufflemean,'r');            subplot(2,1,1);        else            subplot(1,1,1);        end    else        if 0  %might add this one day            hold off;            imagesc(MeanSpike.mu);            return;        end    end            hold off;    end    chspk = chspk(chspk >0 & chspk <= size(ms,1));    voff = CalcVoffset(ms,DATA.chspk,0);    voff = voff-voff(DATA.probe(1));    voff = DATA.voffset-DATA.voffset(DATA.probe(1));    for p = 1:length(tlist)        subplot(length(tlist),2,p*2);        if tlist(p) == clnum            mspk = ms;            muspk = mu;        elseif tlist(p) ==1            mspk = DATA.cluster.MeanSpike.ms;            muspk = DATA.cluster.MeanSpike.mu;        else            mspk = DATA.cluster.next{tlist(p)-1}.MeanSpike.ms;            muspk = DATA.cluster.next{tlist(p)-1}.MeanSpike.mu;        end    for j = chspk        if DATA.plotdvdt && DATA.plotcsd            dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(diff(csd(j,:,id),1,2),[],3) var(diff(csd(j,:,nid),1,2),[],3)]));        elseif DATA.plotdvdt            dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(diff(AllVoltages(j,:,nid),1,2),[],3) var(diff(AllVoltages(j,:,id),1,2),[],3)]));        elseif DATA.plotcsd            dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(csd(j,:,id),[],3) var(csd(j,:,nid),[],3)]));        else            dp = (mspk(j,:)-muspk(j,:))./sqrt(mean([var(AllVoltages(j,:,nid),[],3) var(AllVoltages(j,:,id),[],3)]));        end        dpscale = max(mspk(:))./max(dp);        if DATA.interactive >= 0            plot(muspk(j,:)+voff(j)/5,'color',[0.5 0.5 0.5]);            hold on;            plot(mspk(j,:)+voff(j)/5,'r');            if j == DATA.probe(1)                plot(abs(dp).*dpscale,'m');            else                plot(abs(dp).*dpscale+voff(j)/5,'g');            end            text(size(ms,2),voff(j)/5,sprintf('%d',j+dj),'fontsize',DATA.gui.fontsize(1));        end        peaks = find(diff(sign(diff(abs(dp)))) > 0);        [a,b] = sort(abs(dp(peaks)),'descend');        MeanSpike.dpmax(j,1:length(b)) = peaks(b);        MeanSpike.dp(j,:) = dp;        if recalc        MeanSpike.vdprime(j,:) = dp;        end    end    end    if strcmp(DATA.plot.meantype,'dprimeimage')        imagesc(ms-mu);        subplot(1,2,2);        hold off;        if size(MeanSpike.dp,1) < size(ms,1)            MeanSpike.dp(size(ms,1),:,:) = 0;        end        imagesc(abs(MeanSpike.dp));    end    if DATA.interactive >= 0    set(gca,'xlim',[1 size(ms,2)+1]);    endfunction dp = MSDprime(DATA, chspk, mspk, muspk)                