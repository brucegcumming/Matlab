function S = AddSpikes(DATA, S, e,p, varargin)    verbose = 1;    setdata = 0;    ifnew = 0;        args = {};    j = 1;    while j <= length(varargin)        if strncmpi(varargin{j},'allprobes',6)            args = {args{:} varargin{j}};        elseif strncmpi(varargin{j},'ifnew',5)            ifnew = 1;        elseif strncmpi(varargin{j},'setdata',3)            setdata = 1;        end        j = j+1;    end       mnk = GetMonkeyName(DATA.name);    if ~isfield(DATA,'exptid')        DATA.exptid = DATA.CellDetails.exptids;    end    [a,b] = fileparts(DATA.name);    if isempty(b) %name is a directory        [a,b] = fileparts(a);    end    b = regexprep(b,'[MG]([0-9]*)(.*)','$0');    [c,d] = fileparts(a);    xs = '';    if isempty(S) && isappdata(DATA.toplevel,'AllSpikes')        S = getappdata(DATA.toplevel,'AllSpikes');    end    C = getappdata(DATA.toplevel,'Clusters');    if rem(DATA.exptid(e),1) > 0.001        xs = 'a';    end    name = [DATA.name '/Spikes/' mnk b '.p' num2str(p)  't' num2str(floor(DATA.exptid(e))) xs '.mat'];    if DATA.loadautoclusters        aname = strrep(name,'Spikes','AutoSpikes');        if exist(aname) && (DATA.loadautoclusters == 2 || ~exist(name))            name = aname;        end    end    if ifnew        isnew = 0;        d = dir(name);        if ~isfield(S{e,p}.Header,'loadtime')            isnew = 1;        elseif length(d) == 1 && d.datenum > S{e,p}.Header.loadtime            isnew = 1;        end    else        isnew = 1;    end            if isnew         if verbose > 0            fprintf('Reading %s at %s\n',name,datestr(now));        end        S{e,p} = ReadSpikeFile(name,args{:});        S{e,p}.probe = p;        S{e,p}.filename = name;        if isfield(C{e}{p},'trigset') %Check for a second set of trigger events            name = [DATA.name '/Spikes/' mnk b '.p' num2str(p)  't' num2str(1000+floor(DATA.exptid(e))) xs '.mat'];            X = ReadSpikeFile(name,args{:});            S{e,p}.trigset{1} = X;        end    end    if setdata        setappdata(DATA.toplevel,'AllSpikes',S);    end                     