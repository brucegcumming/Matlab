function E = CountSpikes(Expt, C, clnum,xcl)%E = PC.CountSpikes(Expt, C, clnum,xcl)%finds spikes in C that match trials in Expt, and%adds them to the Expt.Trials strucutre.%clnum 1 = cluster 1, i.e. C.clst == 2        latency = 500;        id = find(C.clst == clnum+1);        t = (C.t(id) .*10000);        for j = 1:length(Expt.Trials)            starts(j) =  Expt.Trials(j).Start(1);            ends(j) =  Expt.Trials(j).End(end);        end        useall = 1; % make user exclude thses trials. Otherwise not recorded        if isempty(id) || useall            npre = 0;            npost = 0;        else        npre = find(starts < t(1));        if npre > 10            id = find(starts < t(1)+10000);            Expt.Trials = Expt.Trials(id);        end        npost = find(starts > t(end));        if npost > 1            id = find(starts < t(end));            Expt.Trials = Expt.Trials(id);        end        end                        for j = 1:length(Expt.Trials)            T = Expt.Trials(j);            id = find(t > T.Start(1)+latency & t <= T.End(end)+latency);            Expt.Trials(j).count = length(t(id));            Expt.Trials(j).Spikes = round([t(id)-T.Start(1)]');            if size(t,2) == 1                Expt.Trials(j).Spikes = Expt.Trials(j).Spikes';            end        end        E = Expt;        [a,b] = setdiff([Expt.Trials.id],xcl);        E.Trials = Expt.Trials(b);        