function HitImage(src,b, type)    ts = now;DATA = GetDataFromFig(src);if DATA.profiling    fprintf('Get took %.3f\n',mytoc(ts));    ts = now;    profile on;endax = get(src,'Parent');xy = get(ax,'currentpoint');l = get(ax,'Children');tag = get(get(ax,'Parent'),'Tag');ex = round(xy(1,2));p = round(xy(1,1));if xy(1,1) > p    setcl = 2;else    setcl = 1;end[Clusters, DATA] = PC.CheckClusterLoaded(DATA, ex);%the celllist plot may have rows that are not in DATA.exptid %if the clustertimes could not be loaded%eid is index in Clusters. ex is row in plotif type == 1    eid = ex;else        eid = find(ismember(DATA.exptid,DATA.CellDetails.exptids(ex)));endDATA.exptno = DATA.exptid(eid);F = GetFigure(src);if ~iscluster(Clusters,eid,p) %error loading    fprintf('No Cluster Times for E%d\n',eid);    return; endbt = strmatch(get(gcf,'SelectionType'),{'normal' 'alternate'  'extend'  'open'});zval = NaN;for j = 1:length(l)    a = get(l(j));    if isfield(a,'CData')        Z = get(l(j),'CData');        zval = Z(ex,p);    endend    cmenu = get(src,'UIContextMenu');    axdata = get(gca,'UserData');offset = DATA.clusteroffset;cntrl_is_down = getappdata(0,'control_is_down');if cntrl_is_down    DATA.selectprobe(ex,p) = ~DATA.selectprobe(ex,p);    DATA.selecth = PC.DrawBoxes(DATA, 3);    bt =4;elseif bt == 2    c = get(cmenu,'children');    tid = find( strcmp('Title',get(c,'Tag')));    [a,b,cl] = PC.isacell(DATA,ex,p);    if a        cid = find(cl == setcl+offset);        if isempty(cid) && setcl+offset > max(cl)            cid = max(cl); %if hit on 2 but only 1 is defined as a cell            thiscell = 0;            if DATA.nclusters(ex,p) >= setcl+offset                cid = setcl+offset;            end        else            thiscell = b(cid);            cid = cl(cid);        end        if length(b) == 1            set(c(tid),'Label',sprintf('E%dP%d Cell %d',ex,p,b));            if length(cid) == 1                set(c(tid),'foregroundcolor',DATA.colors{cid+1});            end        elseif length(cid) == 1 && cid <= length(b)            othercell = setdiff(b,thiscell);            set(c(tid),'Label',sprintf('E%dP%d Cell %d (%s)',ex,p,b(cid),sprintf('%d ',othercell)));            set(c(tid),'foregroundcolor',DATA.colors{cid+1});        else            set(c(tid),'Label',sprintf('E%dP%d Cells%s',ex,p,sprintf('%d ',b)));            if length(cid) == 1                set(c(tid),'foregroundcolor',DATA.colors{cid+1});            end        end    else        if setcl+offset > DATA.nclusters(ex,p)            cid = DATA.nclusters(ex,p);        else            cid = setcl+offset;        end        if cid <= 0            cid = 1;        end        d = PC.isduplicate(DATA,ex,p,cid);        if sum(DATA.selectprobe(:)) > 1            str = [' +' num2str(sum(DATA.selectprobe(:)))];        else            str = '';        end        if d > 0            set(c(tid),'Label',sprintf('E%dP%d Dup%d%s',ex,p,d,str));        else            set(c(tid),'Label',sprintf('E%dP%d%s',ex,p,str));        end    end    axdata.eid = ex;    axdata.probe = p;    axdata.toplevel = DATA.toplevel;    axdata.clnum = cid;    set(gca,'userdata',axdata);    return;endif strcmp(type,'CellRates')    DATA.markexpts = DATA.expnames{ex};    DATA.currentcell = p;    fprintf('E%dC%d',ex,p);    fprintf('Hit %.0f,%.0f %.3f %d\n',ex,p,zval,bt);    PC.PlotMenu(DATA, [], 'cells', 'rateseqone');    return;endfprintf('Hit %.0f,%.0f %.3f type %d,%d\n',ex,p,zval,type,bt);%If not cutting clusters, then set currentcluster to match hit%if htif DATA.nclusters(eid,p) >= setcl    DATA.currentcluster = setcl;endif isempty(Clusters) || DATA.show.cellsummary    PC.DrawBox(ex, p,3,'color','w');    PC.PlotCellSummary(DATA, ex, p);    return;endif ~isfield(Clusters{eid}{p},'clst')    cprintf('red','No clst For E%dP%d\n',ex,p);    return;endif strcmp(type,'duplicates')    A = getappdata(DATA.toplevel,'AllDuplicates');    G = A{ex};    pid = find(floor(G.probes) == p);    if isfield(G,'groups')        gid = find(cellmember(pid,G.groups));        cells = cat(1,G.groups{gid});        if length(cells) > 1            PC.PlotXcorr(DATA,[],cells,G.cells);                    end        set(0,'currentfig',F);        return;    endelseif ismember(type, [1 3]) % 3 = hit cell image - set cell#    if DATA.datatype == 2        C = Clusters{eid}{p}.cluster{DATA.templatesrc};    else        C = Clusters{eid}{p};    end    nc = Counts(C.clst);    nstr = sprintf(' %d',nc);    if isfield(C,'manual')        xstr  = sprintf('Man:%d',C.manual);    else        xstr = [];    end    fprintf('P%d E%.0f cut on %s:%s spks %s\n',p,C.exptno,datestr(C.ctime),nstr,xstr);    if type == 3       it = findobj('Tag','CellNumberId');       cells = sum(DATA.CellList(ex,p,:) > 0);       if cells > 0           lastcell = DATA.currentcell;           a = find(DATA.CellList(ex,p,:) > 0);           id = a(a > offset & a <= offset+2);           if setcl == 2 & length(id) == 2               id = id(2);           elseif isempty(id)               id = offset+setcl;           else               id = id(1);           end           DATA.cellcluster = id;           DATA.currentcluster = id;           DATA.currentcell = DATA.CellList(ex,p,id);           if DATA.currentcell == 0               DATA.currentcell = lastcell;           end           set(it,'value',DATA.currentcell);           cit = findobj('Tag','CellCluster');           set(cit,'value',id);           cit = findobj('Tag','ClusterModifier');           set(cit,'value',id);           if lastcell ~= DATA.currentcell               PC.CellChanged(DATA)           end       end    endelseif type == 2    id = find(DATA.AllPairs(:,1) == ex & DATA.AllPairs(:,2) == p);    if length(id)    xc = PC.meanccf(DATA, id, ex, p);    dist(1) = PC.meanmahal(DATA, id, ex);    dist(2) = PC.meanmahal(DATA, id, p);    PC.SetFigure(DATA,DATA.tag.onecell);    plot(xc);    title(sprintf('Expts %s mahal P%d %.2f, P%d %.2f',num2str(DATA.allexpt(id)),ex,dist(1),p,dist(2)));    end    set(gca,'ylim',[0 max(xc)]);    PC.SetFigure(DATA,DATA.tag.spkmean);    subplot(1,2,1);    ms = PC.MeanSpike(DATA, DATA.allexpt(id), p);    imagesc(ms);    subplot(1,2,2);    ms = PC.MeanSpike(DATA, DATA.allexpt(id), ex);    imagesc(ms);    C = Clusters{DATA.allexpt(id(1))}{p};    ex= DATA.allexpt(id(1));endif bt == 3    if DATA.selecth > 0 & ishandle(DATA.selecth)        delete(DATA.selecth);    end    DATA.selectprobe = zeros(size(DATA.selectprobe));    if p > DATA.currentpoint(2)        DATA.proberange = DATA.currentpoint(2):p;    else        DATA.proberange = p:DATA.currentpoint(2);    end    if ex > DATA.currentpoint(1)        DATA.selectexpts = DATA.currentpoint(1):ex;    else        DATA.selectexpts = ex:DATA.currentpoint(1);    end    DATA.selectprobe(DATA.selectexpts,DATA.proberange) = 1;    DATA.selecth = PC.DrawBox(DATA.selectexpts,DATA.proberange, 3);    if strfind(get(gcf,'Tag'),'CellList')        set(DATA.selecth,'color','w');    endelseif bt == 4    DATA.selectprobe(ex,p) = 1;elseif bt == 2    DATA.selectprobe(ex,p) = ~DATA.selectprobe(ex,p);elseif type == 3    DATA.selectprobe = zeros(length(Clusters),DATA.nprobes);    DATA.selectprobe(ex,p) = 1;endDATA.currentpoint(1) = eid;DATA.currentpoint(2) = p;DATA.currentprobe = DATA.currentpoint(2);DATA = PC.ShowData(DATA,eid,p,'oneprobe');if ismember(bt, [2 3]) && ~strcmp(DATA.plotexpttype,'none')    DATA.Expt = PC.PlotSelectedExpts(DATA,'default');endif DATA.profiling    fprintf('Took %.2f\n',mytoc(ts));    profile viewer;end