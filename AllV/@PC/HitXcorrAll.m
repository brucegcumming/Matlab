function HitXcorrAll(a,b, type, cells, expts)DATA = GetDataFromFig(a);Clusters = getappdata(DATA.toplevel,'Clusters');exids = cat(1,DATA.xcorrs.eid);nex = length(unique(exids));if type == 2%    AllSpikes = getappdata(DATA.toplevel,'AllSpikes');    e = cells(1);    xc = DATA.xcorrs(cells(6));    mysubplot(2,2,2);    xpts = DATA.xcorrval.times;    plot(xpts,xc.xc,'k');    if DATA.plot.xcmax < max(xpts) *1000        set(gca,'xlim',[-DATA.plot.xcmax DATA.plot.xcmax]./1000);    end    yl = get(gca,'ylim');    xl = get(gca,'xlim');    [a,b] = max(xc.xc);    text(xl(2),yl(2),sprintf('Cell %d->%d P%d->%d %.0fms Exp%s',xc.cells(1),...        xc.cells(2),cells(2),cells(3),xpts(b).*1000,DATA.expnames{e}),...        'horizontalalignment','right','verticalalignment','top');    line([0 0],yl,'linestyle','--');    PC.SetFigure(DATA,DATA.tag.spkmean);    subplot(1,2,1);    h = PC.PlotMeanSpike(Clusters{e}{cells(2)},cells(2),cells(4),'imageonly');    set(h,'ButtonDownFcn',{@PC.HitXYPlot, e , cells(2)},'UserData',DATA.toplevel);    subplot(1,2,2);    h = PC.PlotMeanSpike(Clusters{e}{cells(3)},cells(3),cells(5),'imageonly');    set(h,'ButtonDownFcn',{@PC.HitXYPlot, e , cells(3)},'UserData',DATA.toplevel);    PC.SetFigure(DATA,DATA.tag.spikes);    if DATA.plot.synctmax > 0        PC.PlotSyncSpikes(DATA, e, cells([2 3]), cells([4 5]));    end    DATA.selectprobe(e,cells([2 3])) = 1;    DATA.xcid = cells(6);        if strcmp(DATA.plotexpttype,'means')        Expts = getappdata(DATA.toplevel,'Expts');        PC.SetFigure(DATA,DATA.tag.expt);        subplot(1,2,1);        PlotExpt(Expts{e,cells(2)});        subplot(1,2,2);        PlotExpt(Expts{e,cells(3)});    end    set(DATA.toplevel,'UserData',DATA);%    PC.SpoolAllProbes(DATA, e, AllSpikes(e,cells([2 3])), Clusters{e});    return;endcellids = cat(1,DATA.xcorrs.cells);probes = cat(1,DATA.xcorrs.probes);if type == 0 %all probes, not just cells ids = find(probes(:,1) == cells(1) & probes(:,2) == cells(2)); pa = cells(1); pb = cells(2); np = length(unique(probes));else cells([1 2]) = sort(cells([1 2]),'descend'); ida = find(cellids(:,1) == cells(1) & cellids(:,2) == cells(2)); idb = find(cellids(:,2) == cells(1) & cellids(:,1) == cells(2)); ids = cat(1,ida, idb); ids = ids(ismember(exids(ids),expts)); eid = ismember(exids,expts); icells = unique([DATA.xcorrs(eid).cells]); icells = icells(icells > 0); np = length(icells); pa = mean(cat(1,probes(ida,1), probes(idb,2)));  pb = mean(cat(1,probes(idb,1), probes(ida,2))); endids = unique(ids);if nex > 1 %if multiple expts, show ccg for each expt this pair    col = 1;    row = 1;    for j = 1:length(ids)        X = DATA.xcorrs(ids(j));        col = col+1;        if row > floor(np/2)            if col > np                if row > floor(np/2)                    row = row+1;                    col =row+1;                end            end        else            if col > floor(np/2)                row = row+1;                if row == floor(np/2)                    row = row+1;                end                col = row+1;            end        end        k = (row-1)*np + col;        mysubplot(np, np, k,'leftmargin',0.02);        h = plot(DATA.xcorrval.times,X.xc,'r-');        si = PC.SyncIndices(X.xc);        if DATA.plot.synci            fprintf('E%dP%d,%d synci %s\n',X.eid,X.probes(1),X.probes(2),sprintf('%.2f ',si));        end        set(gca,'xtick',[],'ytick',[],'buttondownfcn',{@PC.HitXcorrAll, 2, [X.eid X.probes X.clnum ids(j)],expts});        set(h,'buttondownfcn',{@PC.HitXcorrAll, 2, [X.eid X.probes X.clnum ids(j)], expts});        xl = get(gca,'xlim');        yl = get(gca,'ylim');        text(xl(1),yl(2),sprintf('E%dP%d,%d',X.eid,X.probes(1),X.probes(2)),'horizontalalignment','left','verticalalignment','top');    end    if length(ids)        while row < np            col = col+1;            if row > floor(np/2)                if col > np                    if row > floor(np/2)                        row = row+1;                        col =row+1;                    end                end            else                if col > floor(np/2)                    row = row+1;                    if row == floor(np/2)                        row = row+1;                    end                    col = row+1;                end            end            k = (row-1)*np + col;            mysubplot(np, np, k, 'leftmargin',0.02);            delete(gca);        end    endend mysubplot(2,2,2,'leftmargin',0.02); if length(ids) > 1     weights = prod(cat(1,DATA.xcorrs(ida).n)');     na = sum(weights);     if length(ida) > 1         xca = WeightedSum(cat(1,DATA.xcorrs(ida).xc),weights);     else         ida = DATA.xcorrs(ida).xc;     end     weights = prod(cat(1,DATA.xcorrs(idb).n)');     nb = sum(weights);     if length(idb) == 0         xcb = [];         nb = 0;         xc = xca;     else         if length(idb) > 1             xcb = WeightedSum(cat(1,DATA.xcorrs(idb).xc),weights);         else             xcb = DATA.xcorrs(idb).xc;         end         xc = WeightedSum(cat(1,xca,fliplr(xcb)),[na nb]);     end     efficacy = WeightedSum(cat(1,DATA.xcorrs(idb).effic),nb);     efficacy = max(efficacy);     separation = WeightedSum(cat(1,DATA.xcorrs(idb).separation),weights); else     xc = DATA.xcorrs(ids).xc;     efficacy = max(DATA.xcorrs(ids).effic);     separation = DATA.xcorrs(ids).separation; end xpts = DATA.xcorrval.times; plot(xpts,xc,'k-'); line([0 0],get(gca,'ylim'),'linestyle','--','color','r');yl = get(gca,'ylim');xl = get(gca,'xlim');[a,b] = max(xc);text(xl(2),yl(2),sprintf('C%d->%d %.0fms (%.0f+-%.1f) P%.1f,%.1f Eff%.3f',cells(1),cells(2),xpts(b).*1000,prctile(xc,50),std(xc),pa,pb, efficacy),'horizontalalignment','right','verticalalignment','top');text(xl(2),yl(2),sprintf('Sep%.2f',separation),'horizontalalignment','right','verticalalignment','bottom');