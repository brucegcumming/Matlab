function PlotMahalImage(DATA, type, varargin)colorbarpos = [];j = 1;while j <= length(varargin)    if strncmpi(varargin{j},'colorbarpos',10)        j = j+1;        colorbarpos = varargin{j};    end    j = j+1;endmid = DATA.mahaltype;if isempty(type) || strcmp(type,'distance') %use whatever was last calcuated    imdata = squeeze(DATA.mdistance(:,:,1));elseif isempty(type) || strcmp(type,'mahal') && mid < 5    imdata = squeeze(DATA.mahal(:,:,mid));elseif strncmp(type,'fitdprime',5) || mid == 5    if isfield(DATA,'GaussFitdp')                imdata = -(squeeze(DATA.GaussFitdp(:,:,2)));        imdata(imdata <0) = 0;    else        imdata = squeeze(DATA.mahal(:,:,1));    endelseif strncmp(type,'autodiff',6)    mid = DATA.mahaltype;    imdata = squeeze(DATA.mahal(:,:,mid)-DATA.automahal(:,:,mid));elseif strncmp(type,'BuildDates',6)    imdata = squeeze(DATA.ctimes(:,:,1));endcmenu = PC.AddContextMenu(DATA,'cellplot');imagesc(imdata,'buttondownfcn',{@PC.HitImage, 1},'uicontextmenu',cmenu);set(gcf, 'KeyPressFcn',{@PC.KeyPressed, 1},'Keyreleasefcn',{@PC.KeyReleased, 3},'uicontextmenu',cmenu);colormap('jet');if isempty(colorbarpos)h = colorbar('EastOutside');else    h = colorbar('Position',colorbarpos);end%set(h,'position',[0.9 0.05 0.05 0.9])hold on;if DATA.plot.mahalcmax(1) > 0    caxis([0 DATA.plot.mahalcmax(1)]);endfor j = 1:size(DATA.peakpos,2)    plot(cat(1,j, DATA.peakpos(:,j)),cat(2,0.5,1:size(DATA.peakpos,1)),'w-',...    'buttondownfcn',{@PC.HitImage, 1},'uicontextmenu',cmenu);    hold on;endfor j = 1:size(DATA.mahal,1)    text(1,j,PC.ExLabel(DATA,j),'color','k');endClusters = getappdata(DATA.toplevel,'Clusters');        for j = 1:length(Clusters)            good = find(sum(CellToMat(Clusters{j},'space'),2) > 0)';            for k = good                if Clusters{j}{k}.auto == 0 && DATA.plot.markmanual                    PC.DrawBox(j,k,1,'color','r','uicontextmenu',cmenu);                end                if Clusters{j}{k}.auto == 1 && DATA.plot.markauto                    PC.DrawBox(j,k,1,'color','y','uicontextmenu',cmenu);                end                if isfield(Clusters{j}{k},'marked') && Clusters{j}{k}.marked == 4 && DATA.plot.markgoodmu                    PC.DrawBox(j,k,1,'color','y','uicontextmenu',cmenu);                end                if Clusters{j}{k}.quick == 1 && DATA.markcell.quick                    PC.DrawBox(j,k,1,'color','y','uicontextmenu',cmenu);                end                if DATA.markcell.quick && Clusters{j}{k}.manual == 2                    PC.DrawBox(j,k,1,'color','m','uicontextmenu',cmenu);                end                if DATA.plot.markcopy && isfield(Clusters{j}{k},'manual') && Clusters{j}{k}.manual == 2                    PC.DrawBox(j,k,1,'color','g','uicontextmenu',cmenu);                end                if isfield(DATA.CellDetails,'excludetrials') && length(DATA.CellDetails.excludetrials{j,k}) > 0                    PC.DrawBox(j,k,1,'color','m','uicontextmenu',cmenu);                end                if DATA.plot.markgood && isfield(Clusters{j}{k},'marked') && Clusters{j}{k}.marked == 2                    PC.DrawBox(j,k,1,'color','g','uicontextmenu',cmenu);                end            end        end set(gca,'UserData',DATA.toplevel); set(gcf,'UserData',DATA.toplevel);    