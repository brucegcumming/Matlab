function h = PlotMeanSpike(C, p, cluster, varargin)    addstr = [];    plots = [ 1 1];    DATA = [];    h = [];    colors = mycolors('spkcolors');    j = 1;     while j <= length(varargin)        if isstruct(varargin{j}) && isfield(varargin{j},'ArrayConfig')            DATA = varargin{j};        elseif strncmpi(varargin{j},'addtitile',5)            j = j+1;            addstr = varargin{j};        elseif strncmpi(varargin{j},'lineonly',5)            plots = [0 1];        elseif strncmpi(varargin{j},'imageonly',7)            plots = [1 0];        elseif strncmpi(varargin{j},'smallimage',7)            plots = [4 0];        elseif strncmpi(varargin{j},'exptim',6)            plots = [2 0];        elseif strncmpi(varargin{j},'meanlines',6)            plots = [3 0];        elseif strncmpi(varargin{j},'twoim',5)            plots = [1 2];        elseif strncmpi(varargin{j},'allcluster',10)            plots = [5 0];        end        j = j+1;    end        if isfield(DATA,'probes')        nprobes = DATA.nprobes;    else        nprobes = size(C.MeanSpike.ms,1);    end    if size(C.MeanSpike.ms,1) == 1        chspk = 1;        voff = 0;    else        chspk = C.probe(1) + [-1:1];        chspk = chspk (chspk > 0 & chspk <= nprobes);        if isfield(DATA,'voffset') && length(DATA.voffset) > max(chspk)            voff = DATA.voffset(chspk)-DATA.voffset(p);        else        voff = [-1:1] .*2;        end    end        if cluster == 0 %plot all        nclusters = 1;        for j = 1:length(C.next)            if isfield(C.next{j},'MeanSpike')                nclusters = nclusters+1;            end        end        if size(C.MeanSpike.ms,1) == 1            PC.PlotMeanSpike(C,1,1,'meanlines',DATA);            title(sprintf('P%s/%d Ex %.1f Gm %.2f (%.2f) %s',PC.ProbeLabel(p, DATA),cluster,C.exptno,C.mahal(1),C.mahal(2),addstr));            return;        elseif plots(1) == 3            PC.PlotMeanSpike(C,p,1,'meanlines',DATA);        return;        end        nc = 1;        if sum(plots > 0) > 1            subplot(nclusters,2,1);            np = 2;        else            subplot(nclusters,1,1);            np = 1;        end        if plots(1) == 1            PC.PlotMeanSpike(C, p, 1, 'imageonly',DATA);        end        if np == 2        subplot(nclusters,2,2);        end        if plots(2) == 2            PC.PlotMeanSpike(C, p, -1, 'imageonly',DATA);        elseif plots(2) > 0            PC.PlotMeanSpike(C, p, 1, 'lineonly',DATA);        end        nc = 1;        for j = 1:length(C.next)            if isfield(C.next{j},'MeanSpike')                subplot(nclusters,np,1+nc*np);                if plots(1) == 1                PC.PlotMeanSpike(C, p, j+1, 'imageonly',DATA);                end                if np == 2                subplot(nclusters,np,2+nc*np);                end                if plots(2)                PC.PlotMeanSpike(C, p, j+1, 'lineonly',DATA);                end                nc = nc+1;            end        end        return;    end    if sum(plots > 0) > 1        subplot(1,2,1);    end    if cluster > 1        if length(C.next) > cluster-2            C.next{cluster-1}.exptno = C.exptno;            C = C.next{cluster-1};        end    end    if ~isfield(C,'MeanSpike') %can happen with new cluster        return;    end        if size(C.MeanSpike.ms,1) == 1            p = 1;        elseif p <= 0 && isfield(C,'probe');            p = C.probe(1);        end    if plots(1) == 1 || plots(1) == 4        hold off;        if cluster < 0            h(1) = imagesc(C.MeanSpike.mu);        elseif plots(1) == 4 && isfield(C,'chspk')            h(1) = imagesc(C.MeanSpike.ms(C.chspk,:));        else            h(1) = imagesc(C.MeanSpike.ms);        end        colormap('jet');        if size(C.MeanSpike.ms,1) == 1            p = 1;        elseif p <= 0 && isfield(C,'probe');            p = C.probe(1);        end        line([0 5],[p p],'color','r');        title(sprintf('P%d/%d Ex %.1f D%.2f %s',p,cluster,C.exptno,PC.DistanceMeasure(C,cluster,DATA.mahaltype),addstr));        if sum(plots > 0) > 1            subplot(1,2,2);        end    elseif plots(1) == 3 %mean lines        if cluster == 0            subplot(1,1,1);        hold off;        voff(1) = 0;        for j = 1:length(chspk)            mm(j,:,1) = minmax(C.MeanSpike.ms(chspk(j),:));            if cluster == 0            for k = 1:length(C.next)                mm(j,:,k+1) = minmax(C.next{k}.MeanSpike.ms(chspk(j),:));            end            end            mx(j,1) = min(mm(j,1,:));            mx(j,2) = max(mm(j,2,:));            if j > 1                voff(j) = mx(j-1,2)-mx(j,1);            end        end        voff = cumsum(voff).*0.8;                for j = 1:length(chspk)             plot(C.MeanSpike.ms(chspk(j),:)+voff(j),'r','linewidth',2);             hold on;             plot(C.MeanSpike.mu(chspk(j),:)+voff(j),'color',colors{1},'linewidth',2);             if cluster == 0             for k = 1:length(C.next)                 if isfield(C.next{k},'MeanSpike')                     plot(C.next{k}.MeanSpike.ms(chspk(j),:)+voff(j),'color',colors{k+2},'linewidth',2);                 end             end             end        end        else            voff = zeros(size(chspk));            for j = 1:length(chspk)                plot(C.MeanSpike.ms(chspk(j),:)+voff(j),'color',colors{j+1},'linewidth',2);                hold on;            end            if length(chspk) == 1                plot(C.MeanSpike.mu(chspk,:)+voff(j),'color',colors{1},'linewidth',2);            end        end            elseif plots(1) == 5 % plot mean spikes of clusters in all Expts on a probe        if cluster == 1            line(1:length(C.MeanSpike.mu(p,:)),C.MeanSpike.mu(p,:),'Color',...                colors{1},'LineWidth',2)        end        line(1:length(C.MeanSpike.ms(p,:)),C.MeanSpike.ms(p,:),'Color',...            colors{cluster+1},'LineWidth',2)    end    if plots(2)        hold off;        v = std(C.MeanSpike.ms');        id = find(v > max(v)/2);                if length(v) >= p && v(p) < 0.1 %low v range so rescale dp;            x = max(abs(minmax(C.MeanSpike.ms(:))));            dpscale = x/3;        else            dpscale = 1;        end        for j = id            h(2) = plot(C.MeanSpike.ms(j,:),'r');            hold on;            if isfield(C.MeanSpike,'dp') && size(C.MeanSpike.dp,1) >= j                plot(C.MeanSpike.dp(j,:).*dpscale,'g');            end            plot(C.MeanSpike.mu(j,:),'color',[0.5 0.5 0.5]);        end    end