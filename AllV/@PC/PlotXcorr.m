function PlotXcorr(a,b, pa, pb)DATA = GetDataFromFig(a);DATA = SaveCallback(DATA,a);if nargin < 4    pb =[];endF = GetFigure(a);cells = getappdata(DATA.toplevel,'xcCellList');if isappdata(F,'CellGroups')    CellGroups = getappdata(F,'CellGroups');    if isfield(CellGroups,'cells')        cells = CellGroups.cells;        if isfield(CellGroups,'order')            cells = cells(CellGroups.order);        end    endendif isstruct(pb)    cells = pb;    pb = [];end    if isempty(b) %from GUI    plottype = DATA.plot.xcorrtype;    bt = strmatch(get(gcf,'SelectionType'),{'normal' 'alternate'  'extend'  'open'});else    plottype = b;    bt = 1;endif strcmp(pa,'zoom')    xl = get(gca,'xlim');    if bt == 2         xl(1) = xl(1)*2;        xl(2) = xl(2)*2;    elseif bt ==1        xl(1) = xl(1)/2;        xl(2) = xl(2)/2;    end    set(gca,'xlim',xl);    return;endif strcmp(pa,'xcorr')    xcorrs = getappdata(DATA.toplevel,'xcorrs');    xc = xcorrs(pb);    pa = xc.p(1);    pb = xc.p(2);endif bt == 2    return;endGetFigure(DATA.tag.xcorr,DATA.toplevel,'front');control_is_down = getappdata(0,'control_is_down');DataClusters = getappdata(DATA.toplevel,'Clusters');selected = getappdata(DATA.toplevel,'xcSelected');if control_is_down    ax = findobj(gcf,'type','axes','userdata',[pa pb]);    set(ax,'color','c');    selected(pa,pb) = 1;elseif nargin > 3 && ~isstruct(pb)    ax = findobj(gcf,'type','axes','userdata',[pa pb]);    set(ax,'color','w');    selected(pa,pb) = 0;endsetappdata(DATA.toplevel,'xcSelected',selected);eid = DATA.currentpoint(1);colors = DATA.colors;if strcmp(plottype,'meanim')    PC.SetFigure(DATA, DATA.tag.xcorr);    mysubplot(2,4,3);    P = PC.Cell2Cluster(cells(pa),DataClusters{eid});    imagesc(P.MeanSpike.ms);    set(gca','xtick',[],'ytick',[]);    h = title(sprintf('%d/%d',cells(pa).p,cells(pa).cl));    set(h,'verticalalignment','middle')    mysubplot(2,4,4);    Q = PC.Cell2Cluster(cells(pb),DataClusters{eid});    cl = minmax(cat(1,Q.MeanSpike.ms(:),P.MeanSpike.ms(:)));    caxis(cl);    imagesc(Q.MeanSpike.ms);    caxis(cl);    set(gca','xtick',[],'ytick',[]);    h = title(sprintf('%d/%d',cells(pb).p,cells(pb).cl));    set(h,'verticalalignment','middle')    xc = PC.ShapeCorr(P,Q);    return;elseif strcmp(plottype,'histograms')    mysubplot(2,2,2);    if nargin < 4        cid = pa;    elseif control_is_down        [a,b] = find(selected);        cid = unique([a b]);    else        cid = [pa pb];    end    hold off; %   ClusterDetails = getappdata(DATA.toplevel,'ClusterDetails');    for j = 1:length(cid)        c = cid(j);        P = PC.Cell2Cluster(cells(cid(j)),DataClusters{eid});        [x, nsp] = PC.PlotHist(P.xy,P,'noplot');        h(j) = plot(1:length(x),nsp ./ max(nsp),'color',colors{j},...            'linewidth',2);        hold on;            end    %legend(h,labels);ylabel('Cluster');    if pa > length(cells)/2        mysubplot(2,2,1);    else        mysubplot(2,2,4);    end    xl = get(gca,'xlim');    for j = 1:length(cid)        c = cid(j);        P = PC.Cell2Cluster(cells(cid(j)),DataClusters{eid});        if isfield(P,'triggerV')            [y,hx] = hist(P.triggerV,100);            x = xl(1) + (hx-min(hx)).*diff(minmax(xl))./diff(minmax(hx));            h(j) = plot(1:length(x),y./max(y),'color',colors{j},'linewidth',2);        else            h(j) = plot([1 2],[0 0],'color',colors{j});        end        hold on;        labels{j} = sprintf('%d/%d: %.2f %.1f',cells(c).p,cells(c).cl,P.fitdprime(1),P.dropi(3));    end    mylegend(h,labels);    ylabel('Trigger');    return;elseif strcmp(DATA.plot.xcorrtype,'syncspikes')mysubplot(2,2,2);PC.PlotSyncSpikes(DATA, eid, [cells(pa).p cells(pb).p], [cells(pa).cl cells(pb).cl]);return;elseif strcmp(DATA.plot.xcorrtype,'alleg')    PC.SetFigure(DATA, DATA.tag.xcorr);    mysubplot(2,4,1);    P = PC.Cell2Cluster(cells(pa),DataClusters{eid});    imagesc(P.MeanSpike.ms);    set(gca','xtick',[],'ytick',[]);    h = title(sprintf('%d/%d',cells(pa).p,cells(pa).cl));    set(h,'verticalalignment','middle')    mysubplot(2,4,2);    Q = PC.Cell2Cluster(cells(pb),DataClusters{eid});    cl = minmax(cat(1,Q.MeanSpike.ms(:),P.MeanSpike.ms(:)));    caxis(cl);    imagesc(Q.MeanSpike.ms);    caxis(cl);    xc = PC.ShapeCorr(P,Q,'delays',5);    set(gca','xtick',[],'ytick',[]);    h = title(sprintf('%d/%d',cells(pb).p,cells(pb).cl));    set(h,'verticalalignment','middle')mysubplot(2,2,4);hold off; cid = [pa pb];    for j = 1:length(cid)        c = cid(j);        P = PC.Cell2Cluster(cells(cid(j)),DataClusters{eid});        [x, nsp, crit] = PC.PlotHist(P.xy,P,'noplot');        crit = length(x) .* crit/max(x);        h(j) = plot(1:length(x),nsp ./ max(nsp),'color',colors{j},...            'linewidth',2);        hold on;        line([crit crit],[0 1],'color',colors{j});        labels{j} = sprintf('P%d/%d drop%.1f',P.probe,P.cluster,P.dropi(3));        if isfield(P,'triggerV')            [y,xh] = smhist(P.triggerV);            plot([1:length(xh)] .* length(x)./length(xh),y ./ max(y),'color',colors{j},...                'linewidth',2,'linestyle',':');        end    endmylegend(h,labels);title('Cluster Separation/Trigger Value(dotted)');mysubplot(2,2,3);PC.PlotSyncSpikes(DATA, eid, [cells(pa).p cells(pb).p], [cells(pa).cl cells(pb).cl]);%return;endif length(pb) > 1 || length(pa) > 1    if nargin == 2        cid = pa;    else        cid = [pa pb];    end    if isfield(cells,'eid')        eid = unique([cells(cid).eid]); %should be one number    end    nc = length(cid);    for j = 1:length(cid)        for k = 1:j            P = PC.Cell2Cluster(cells(cid(j)),DataClusters{eid});            Q = PC.Cell2Cluster(cells(cid(k)),DataClusters{eid});            if isfield(P,'times') && isfield(Q,'times')                [xc, details]  = xcorrtimes(P.times,Q.times);                mysubplot(nc,nc,j + (k-1)*nc);                hold off;                plot(details.xpts,xc,'k','linewidth',2);                axis('tight');                yl = get(gca,'ylim');                xl = get(gca,'xlim');                [a,b] = max(xc);                text(xl(2),yl(2),sprintf('%.0fms %.3f %d/%d %d/%d',...                    details.xpts(b).*1000,max(details.efficacy),...                    cells(cid(j)).p,cells(cid(j)).cl,cells(cid(k)).p,cells(cid(k)).cl),'horizontalalignment','right','verticalalignment','top');                line([0 0],yl,'linestyle','--');                set(gca,'buttondownfcn', {@PC.PlotXcorr, 'zoom', 2});            end        end    end    return;else    mysubplot(2,2,2);    P = PC.Cell2Cluster(cells(pa),DataClusters{eid});    Q = PC.Cell2Cluster(cells(pb(1)),DataClusters{eid});    [xc, details]  = xcorrtimes(P.times,Q.times);endif pa == pb    xc(details.midpt) = 0;endhold off;plot(details.xpts,xc,'k','linewidth',2);axis('tight');yl = get(gca,'ylim');xl = get(gca,'xlim');[a,b] = max(xc);text(xl(2),yl(2),sprintf('%.0fms %.3f %d/%d %d/%d',...    details.xpts(b).*1000,max(details.efficacy),...    cells(pa).p,cells(pa).cl,cells(pb).p,cells(pb).cl),'horizontalalignment','right','verticalalignment','top');line([0 0],yl,'linestyle','--');set(gca,'buttondownfcn', {@PC.PlotXcorr, 'zoom', 2});