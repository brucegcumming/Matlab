function PlotXcorrs(DATA, xcorrs, expts, bycell)%Plot CCFs for all pairs%High efficacies plotted in red%high values of sunci (old index) in blue    ClearPlot;    if bycell        xcorrs = xcorrs([xcorrs.valid] == 1);        cellids = cat(1,xcorrs.cells);        cellids(isnan(cellids)) = 0;    else        cellids = cat(1,xcorrs.probes);    end    exids = cat(1,xcorrs.eid);    weights = prod(cat(1,xcorrs.n)');    cells = unique(cellids);    cells = setdiff(cells, find(DATA.plot.xcorrexclude));    cells = cells(cells > 0);    probes = cat(1,xcorrs.probes);    np = length(cells);    ns = 0;    for j = 1:length(cells)        ida = find(cellids(:,1) == cells(j) & ismember(exids,expts));        idb = find(cellids(:,2) == cells(j) & ismember(exids,expts));        cellpos(j) = (sum(probes(ida,1))+sum(probes(idb,2)))./(length(ida)+length(idb));        for k = 1:j            ida = find(cellids(:,1) == cells(j) & cellids(:,2) == cells(k) & ismember(exids,expts));            idb = find(cellids(:,2) == cells(j) & cellids(:,1) == cells(k) & ismember(exids,expts));            if length(ida)+length(idb) > 0                separation(j,k) =( sum([xcorrs(ida).separation]) - sum([xcorrs(idb).separation]))./(length(ida)+length(idb));            else                separation(j,k) = cellpos(j)-cellpos(k);            end            separation(k,j) = -separation(j,k);        end    end    order = sum(separation < 0);    [a,b] = sort(order);    icells = cells; %unsorted    if strcmp(DATA.ArrayConfig.type,'MultiWire')        %don't know how to sort these yet..    else        cells = cells(b);    end    for j = 1:length(cells)        for k = 1:j            id = find((cellids(:,1) == cells(j) & cellids(:,2) == cells(k)) | (cellids(:,2) == cells(j) & cellids(:,1) == cells(k)));            id = id(ismember(exids(id),expts));            if length(id)                if length(id) > 1                    xc = WeightedSum(cat(1,xcorrs(id).xc),weights(id));                    effic = WeightedSum(cat(1,xcorrs(id).effic),weights(id));                    effix = max(effic);                else                    xc = xcorrs(id).xc;                    effic = max(xcorrs(id).effic);                end                mysubplot(np,np,k+(j-1)*np,'leftmargin',0.02);                h = plot(-200:200,xc,'k-','linewidth',2);                synci = PC.SyncIndices(xc);                if effic > DATA.crit.synci(2);                    set(h,'color','r');                elseif synci(2) < DATA.crit.synci(1)                      set(h,'color','b');                end                if ~isnan(synci(2))                    ns = ns+1;                    syncis(ns,1:length(synci)) = synci;                    syncis(ns,3) = cells(j);                    syncis(ns,4) = cells(k);                end                axis('tight');                xl = get(gca,'xlim');                yl = get(gca,'ylim');                set(gca,'xtick',[],'ytick',[],'buttondownfcn',{@PC.HitXcorrAll,bycell,[cells(j) cells(k)], expts});                set(h,'buttondownfcn',{@PC.HitXcorrAll,bycell,[cells(j) cells(k)],expts});                if k == j                    [a,b] = find(DATA.CellList == cells(k));                    p = 1+mod(b-1,DATA.nprobes);                    cl = ceil(b/DATA.nprobes);                    if j == 1 || DATA.plot.xcorrlabeltop == 1                        title(sprintf('Cell%d',cells(k)));                    else                        ii = find(icells == cells(k-1));                        ij  = find(icells == cells(j));                        if bycell                            h = text(xl(1),yl(2),sprintf('C%d at %s (%.1f)',cells(k),PC.ProbeLabel(p, DATA, cl),separation(ii,ij)));                            set(h,'HorizontalAlignment','left','verticalalignment','bottom');                        else                            title(sprintf('P%s',PC.ProbeLabel(k, DATA)));                        end                    end                end                if k == 1                    ylabel(sprintf('Cell%d',cells(j)));                end            end        end    end    if DATA.plot.synci    mysubplot(2,2,2);    myscatter(syncis(:,1),syncis(:,2),'o','ids',syncis(:,3:4));    end    