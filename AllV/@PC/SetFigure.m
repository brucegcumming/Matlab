function [f, isnew] = SetFigure(DATA, tag, varargin)%[f, isnew] = SetFigure(DATA, tag, varargin)onoff = {'off' 'on'};    [f,isnew] = GetFigure(tag,'ParentFigure',DATA.toplevel,varargin{:});    if isnew        if strfind(tag,'AllXY');            set(f,'UserData', DATA.toplevel);            hm = uimenu(f,'Label','&Options','Tag','Options');            uimenu(hm,'Label','&Keep This Graph','callback', {@PC.ChangeTag, 'allxy'});            uimenu(hm,'Label','Show &Means','callback', {@PC.PlotMenu, 'cells' 'allmean'});            uimenu(hm,'Label','Show &XY','callback', {@PC.PlotMenu, 'cells' 'allxy'});            uimenu(hm,'Label','&Density','callback', {@PC.OptionMenu, 1});            uimenu(hm,'Label','&Optimize all','callback', {@PC.OptionMenu, 'optimizeall'});            uimenu(hm,'Label','Add Context Menus','callback', {@PC.PlotMenu, 'cells' 'addcontext'},'checked',onoff{1+DATA.show.linecontextmenus});        elseif strfind(tag,'Comments')            x = get(DATA.toplevel,'Position');            set(f,'position',[x(1) x(2) 300 50],'menubar','none');            uicontrol(f, 'string',[],'style','edit','units','normalized','position',[0.05 0.55 0.9 0.45],...                'Callback',{@PC.AddComment, []});            uicontrol(f, 'string','Done','style','pushbutton','units','normalized','position',[0.05 0.05 0.2 0.45],...                'Callback',{@PC.AddComment, []});            uicontrol(f, 'string','Done','style','text','units','normalized','position',[0.25 0.05 0.7 0.45],...                'Tag','ProbeLabel');                        set(f,'UserData',DATA.toplevel);        elseif strfind(tag,'CellSummary');            hm = uimenu(f,'Label','Cell','Tag','CellList');            set(f,'UserData', DATA.toplevel);        elseif strfind(tag,'CellList');            hm = uimenu(f,'Label','&Plots','Tag','PlotMenu','accelerator','p');            sm = uimenu(hm,'Label','&Cells','Tag','ProbePlotMenu','accelerator','c');            PC.AddPlotMenu(sm,'cells');            sm = uimenu(hm,'Label','&Probes','Tag','ProbePlotMenu','accelerator','p');            PC.AddPlotMenu(sm,'probes');            sm = uimenu(hm,'Label','&Show','Tag','ShowPlotMenu');            PC.AddPlotMenu(sm, 'show');            uimenu(hm,'Label','AllXY','Callback',{@PC.PlotMenu, 'cells' 'allxy'});            uimenu(hm,'Label','All Means','Callback',{@PC.PlotMenu, 'cells' 'allmean'});            uimenu(hm,'Label','All Mean image','Callback',{@PC.PlotMenu, 'cells' 'allmean'});            uimenu(hm,'Label','All Trigger hist','Callback',{@PC.PlotMenu, 'cells' 'trighist'});            uimenu(hm,'Label','All Spks','Callback',{@PC.PlotMenu, 'cells' 'allspks'});            uimenu(hm,'Label','All Spks when change cell','Callback',{@PC.PlotMenu, 'cells' 'watchallcellspks'},'tag','watchallcellspks');            uimenu(hm,'Label','All Mean when change cell','Callback',{@PC.PlotMenu, 'cells' 'watchallcellmean'},'tag','watchallcellmean');            uimenu(hm,'Label','All XY when change cell','Callback',{@PC.PlotMenu, 'cells' 'watchallcellxy'},'tag','watchallcellxy');            uimenu(hm,'Label','SpkRate','Callback',{@PC.PlotMenu, 'cells' 'spkrate'});            uimenu(hm,'Label','SpkRate+xy sequence','Callback',{@PC.PlotMenu, 'cells' 'spkrate+xy'});            uimenu(hm,'Label','All','Callback',{@PC.PlotMenu, 'cells' 'allplots'});            uimenu(hm,'Label','All - next cell','Callback',{@PC.PlotMenu, 'cells' 'allnext'});            uimenu(hm,'Label','All Cell &Tuning This Expt','Callback',{@PC.PlotMenu, 'cells' 'allexpttune'});            uimenu(hm,'Label','All Tuning This Cell','Callback',{@PC.PlotMenu, 'cells' 'allcelltune'});                        uimenu(hm,'Label','Estimate Drift','Callback',{@PC.PlotMenu, 'cells' 'driftestimate'});            uimenu(hm,'Label','Cell Summary','Callback',{@PC.PlotMenu, 'cells' 'summary'});            uimenu(hm,'Label','->AllVpcs','Callback',{@PC.GuiMenu, 'CallAllVPcs'},'accelerator','a');                        hm = uimenu(f,'Label','&Cells','Tag','CellMenu');            uimenu(hm,'Label','&Fill Using Marked','Callback',{@PC.OptionMenu 'fillcellsfrommark'});            uimenu(hm,'Label','Check &Rate sequences','Callback',{@PC.OptionMenu 'checkratesequence'});            uimenu(hm,'Label','Plot Rate sequence All Cells','Callback',{@PC.PlotMenu, 'cells', 'rateseqall'});            uimenu(hm,'Label','Rate Sequence current cell','Callback',{@PC.PlotMenu, 'cells', 'rateseqone'});            uimenu(hm,'Label','Calculate Means','Callback',{@PC.OptionMenu 'calccellmeans'});            hm = uimenu(f,'Label','&Mark','Tag','MarkMenu');            uimenu(hm,'Label',sprintf('Dropi < %.1f',DATA.crit.dropi),'Callback',{@PC.PlotMenu, 'cells' 'markdropi'},'Tag','markdropi');            uimenu(hm,'Label','Candidates','Callback',{@PC.PlotMenu, 'cells' 'markcandidates'});            uimenu(hm,'Label','mahal < 3','Callback',{@PC.PlotMenu, 'cells' 'markmahal'});            uimenu(hm,'Label','Ellipses','Callback',{@PC.PlotMenu, 'cells' 'markellipse'});            uimenu(hm,'Label','&Quick','Callback',{@PC.PlotMenu, 'cells' 'markquick'});            uimenu(hm,'Label','&Auto Cuts','Callback',{@PC.PlotMenu, 'cells' 'markauto'});            uimenu(hm,'Label','Old readmethod','Callback',{@PC.PlotMenu, 'cells' 'markreadmethod'});            uimenu(hm,'Label','Tagged','Callback',{@PC.PlotMenu, 'cells' 'marktagged'});            uimenu(hm,'Label','Good Cell','Callback',{@PC.PlotMenu, 'cells' 'markgoodcell'});            uimenu(hm,'Label','Good MU','Callback',{@PC.PlotMenu, 'cells' 'markgoodmu'});            uimenu(hm,'Label','Grid','Callback',{@PC.PlotMenu, 'cells' 'markgrid'});            uimenu(hm,'Label','Expt &Names','Callback',{@PC.PlotMenu, 'cells' 'markexpnames'});            sm = uimenu(hm,'Label','&Expts','Tag','ExptMarkMenu');            PC.AddExptList(sm,'markexpts',DATA)            sm = uimenu(hm,'Label','&Other','Tag','OtherPlotMenu');            uimenu(sm,'Label','Shape/Size','Callback',{@PC.PlotMenu, 'cells' 'shapesize'});            uimenu(sm,'Label','ISI Hist','Callback',{@PC.PlotMenu, 'showplot' 'isihist'});            uimenu(sm,'Label','Make Menu For Last Op','Callback',{@PC.OptionMenu, 'postmenu'},'tag','PostMenu');                        bp = [0.01 0.001 0.15 0.04];            uicontrol(gcf,'style','pop','string',num2str([1:50]'), ...        'Tag','CellNumberId','Callback', {@PC.SetCellNumber, 'change'},...        'units', 'norm', 'position',bp,'value',DATA.currentcell);            bp = [0.1 0.001 0.08 0.04];            it = uicontrol(gcf,'style','pushbutton','string','Set', ...                'Callback', {@PC.SetCellNumber, 'set'}, 'Tag','SetCell', ...                 'units', 'norm', 'position',bp,'value',1);            bp(1) = bp(1)+bp(3);            bp(3) = 0.16;            uicontrol(gcf,'style','pop','string','Cluster 1 ThisSquare|Cluster 2 This Square|Cluster 3|Cluster 4|Cluster 5|Cluster 6|Use Template Peaks|Better than mahal|Quality-suboptimal|Quality-poor|Spool All Expts|AllXY|AllMean|AllMeanIm|Exclude Selected Trials|Exclude Trials for C2', ...        'Tag','ClusterModifier','callback',{@PC.CellTrackMenu, 'setcluster'},...                'units', 'norm', 'position',bp,'value',1);            bp(1) = bp(1)+bp(3);            bp(3) = 0.08;            uicontrol(gcf,'style','pop','string','1+2|3+4|5+6', ...        'Tag','CellPlane','callback',{@PC.CellTrackMenu, 'setplane'},...        'units', 'norm', 'position',bp,'value',1);            bp(1) = bp(1)+bp(3);            uicontrol(gcf,'style','pushbutton','string','Delete', ...                'Callback', {@PC.SetCellNumber, 'delete'}, 'Tag','DeleteCell',...                'units', 'norm', 'position',bp,'value',1);            bp(1) = bp(1)+bp(3);            uicontrol(gcf,'style','pop','string','1|2|3|4|5|6', ...        'Tag','CellCluster','callback',{@PC.CellTrackMenu, 'setcluster'},...        'units', 'norm', 'position',bp,'value',1);    bp(1) = bp(1)+bp(3);    bp(3) = 0.2;    it = uicontrol(gcf,'style','pushbutton','string','Set Duplicate', ...        'Callback', {@PC.SetCellNumber, 'duplicates'}, 'Tag','SetDuplicate',...        'Keypressfcn',{@PC.KeyPressed, 3},...        'units', 'norm', 'position',bp,'value',1);        set(f,'UserData', DATA.toplevel);        elseif strcmp(tag,DATA.tag.allspikes)            Expts = getappdata(DATA.toplevel,'Expts');             DATA.Expt = Expts{DATA.currentpoint(1)};            bp = [0.95 0.05 0.05 0.9];            h = uicontrol(f,'Style', 'list',...                'String', num2str([DATA.Expt.Trials.Trial]'), 'Tag', 'ChooseTrial','Units','norm', 'Position', bp,'value',1,...                'Max',3,'Min',1,'Callback',{@PC.SelectTrial, 'all'});            bp = [0.95 0.95 0.05 0.05];            uicontrol(f,'style','check','string','stop','Units','Normalized','Position',bp,'Tag','StopSpool',...            'value',0);        hm = uimenu(f,'Label','Spool','Tag','Cluster');        uimenu(hm,'Label','Selected','Callback',{@PC.PlotMenu, 'probes', 'spoolcurrent'});        uimenu(hm,'Label','Synchronous','Callback',{@PC.PlotMenu, 'probes', 'plotsync'});        uimenu(hm,'Label','Synchronous Flip','Callback',{@PC.PlotMenu, 'probes', 'plotsyncb'});        hm = uimenu(f,'Label','Options','Tag','Cluster');        uimenu(hm,'label','Keep','callback', {@PC.ChangeTag, 'allspikes'});        uimenu(hm,'label','Ues one scale','callback', {@PC.PlotMenu, 'probes' 'onescale'});        uimenu(hm,'Label','Add Context Menus','callback', {@PC.PlotMenu, 'cells' 'addcontext'},'checked',onoff{1+DATA.show.linecontextmenus});             set(f,'UserData',DATA.toplevel);                    elseif strfind(tag,'ClustersAll');            hm = uimenu(f,'Label','Mark','Tag','MarkMenu');            uimenu(hm,'Label','Manual Cut','Callback',{@PC.PlotMenu, 'allcluster' 'markmanual'});            uimenu(hm,'Label','Auto Cut','Callback',{@PC.PlotMenu, 'allcluster' 'markauto'});            uimenu(hm,'Label','Copied','Callback',{@PC.PlotMenu, 'allcluster' 'markcopy'});            uimenu(hm,'Label','Marked Good','Callback',{@PC.PlotMenu, 'allcluster' 'markgood'});            uimenu(hm,'Label','Bad Probes','Callback',{@PC.PlotMenu, 'allcluster' 'markbadprobe'});            uimenu(hm,'Label','Good Mu','Callback',{@PC.PlotMenu, 'allcluster' 'markgoodmu'});            uimenu(hm,'Label','Excluded Trials','Callback',{@PC.PlotMenu, 'allcluster' 'markexclusions'});            uimenu(hm,'Label','Quick','Callback',{@PC.PlotMenu, 'cells' 'markquick'});            set(f,'UserData', DATA.toplevel);        elseif strcmp(tag,DATA.tag.xcorr)            set(f,'UserData', DATA.toplevel);            optm = uimenu(f,'Label','Options','Tag','XcorrOptions');            hm = uimenu(optm,'Label','Zoom','Tag','xcZoom');            sm = uimenu(hm,'Label','Main plot');            uimenu(sm,'Label','10ms','Callback',{@PC.PlotMenu, 'xcorr', 'zoom', 10});            uimenu(sm,'Label','50ms','Callback',{@PC.PlotMenu, 'xcorr', 'zoom', 50});            uimenu(sm,'Label','100ms','Callback',{@PC.PlotMenu, 'xcorr', 'zoom', 100});            uimenu(sm,'Label','200ms','Callback',{@PC.PlotMenu, 'xcorr', 'zoom', 200});            sm = uimenu(hm,'Label','Sync Spikes');            uimenu(sm,'Label','Off','Callback',{@PC.PlotMenu, 'xcorr', 'spkzoom', 0});            uimenu(sm,'Label','2ms','Callback',{@PC.PlotMenu, 'xcorr', 'spkzoom', 2});            uimenu(sm,'Label','5ms','Callback',{@PC.PlotMenu, 'xcorr', 'spkzoom', 5});            uimenu(sm,'Label','10ms','Callback',{@PC.PlotMenu, 'xcorr', 'spkzoom', 10});            uimenu(sm,'Label','20ms','Callback',{@PC.PlotMenu, 'xcorr', 'spkzoom', 20});            PC.AddPlotMenu(optm, 'xcorrplot');            hm = uimenu(optm,'Label','Labels','Tag','xcLabels');            uimenu(hm,'Label','Cell# on left','Callback',{@PC.PlotMenu, 'xcorr', 'labelcellleft', 0});            uimenu(hm,'Label','Cell# on top','Callback',{@PC.PlotMenu, 'xcorr', 'labelcelltop', 0});            hm = uimenu(optm,'Label','replot','Tag','xcreplot','Callback',{@PC.PlotMenu, 'xcorr', 'replot', 0});            hm = uimenu(f,'Label','Exclude','Tag','Xcorrexclude');            cellid = unique(DATA.CellList);            cellid = cellid(cellid > 0);            for j = 1:length(cellid)                uimenu(hm,'Label',['Cell ' num2str(cellid(j))],'Callback',{@PC.PlotMenu, 'xcorr', 'exclude', cellid(j)});            end            setappdata(f,'ParentFigure', DATA.toplevel);            set(gcf, 'KeyPressFcn',{@PC.KeyPressed,4},'Keyreleasefcn',{@PC.KeyReleased, 4});        elseif strfind(tag,'Spikes')            Expts = getappdata(DATA.toplevel,'Expts');             DATA.Expt = Expts{DATA.currentpoint(1)};             if isfield(DATA.Expt,'Trials')            bp = [0.9 0.05 0.1 0.9];            h = uicontrol(f,'Style', 'list',...                'String', num2str([DATA.Expt.Trials.Trial]'), 'Tag', 'ChooseTrial','Units','norm', 'Position', bp,'value',1,...                'Max',3,'Min',1,'Callback',{@PC.SelectTrial, 'one'});             end            bp = [0.9 0.95 0.05 0.05];            uicontrol(f,'style','check','string','stop','Units','Normalized','Position',bp,'Tag','StopSpool',...            'value',0);            bp = [0.01 0.01 0.06 0.05];            uicontrol(f,'style','pushbutton','string','AllEx','Units','Normalized','Position',bp,'Tag','AllExptButton',...            'value',0,'callback',{@PC.PlotMenu, 'probes', 'allprobespks'});            bp(1) = bp(1)+bp(3);            bp(3)=0.08;            uicontrol(f,'style','pushbutton','string','AllProbes','Units','Normalized','Position',bp,'Tag','AllExptButton',...            'value',0,'callback',{@PC.PlotMenu, 'probes', 'allspks'});                        set(f,'UserData',DATA.toplevel);            hm = uimenu(f,'Label','&Spool','Tag','Spool');            uimenu(hm,'Label','This Probe','Callback',{@PC.PlotMenu, 'spikes', 'Spool'});            uimenu(hm,'Label','Sync Spikes','Callback',{@PC.PlotMenu, 'probes', 'spoolsync'});            uimenu(hm,'Label','&Exclude Selected Trials (current cluster)','Callback',{@PC.OptionMenu, 'excludecurrent'});        elseif strfind(tag,'XYplot');                hm = uimenu(f,'Label','&Cluster','Tag','Cluster');                uimenu(hm,'Label','&SaveChanges','Callback',{@PC.XYCluster, 'save'});                uimenu(hm,'Label','&QuickSave (q)','Callback',{@PC.XYCluster, 'quicksave'});%                uimenu(hm,'Label','Cut Ellipses','Callback',{@PC.XYCluster, 'ellipses'});                sm = uimenu(hm,'Label','Cut &Ellipse','Tag','EllipseMenu');                for j = 1:6                    s = num2str(j);                    uimenu(sm,'Label',['Cluster &' s],'foregroundcolor',DATA.colors{j+1},'Callback',{@PC.XYCluster, ['ellipse' s]},'accelerator',s);                end                sm = uimenu(hm,'Label','&View Cluster','Tag','EllipseMenu');                for j = 1:6                    s = num2str(j);                    uimenu(sm,'Label',['Cluster &' s],'foregroundcolor',DATA.colors{j+1},'Callback',{@PC.XYCluster, ['select' s]},'accelerator',s);                end                sm = uimenu(hm,'Label','&Delete','Tag','EllipseMenu');                for j = 2:6                    s = num2str(j);                    uimenu(sm,'Label',['Cluster &' s],'foregroundcolor',DATA.colors{j+1},'Callback',{@PC.XYCluster, ['clear' s]},'accelerator',s);                end                uimenu(hm,'Label','Cut &Lines','Callback',{@PC.XYCluster, 'lines'},'accelerator','L');                uimenu(hm,'Label','Flip Line Criterion (f)','Callback',{@PC.XYCluster, 'flip'},'accelerator','F'); %               uimenu(hm,'Label','Ellipse for Cl2','Callback',{@PC.XYCluster, 'ellipse2'});                uimenu(hm,'Label','&No Cutting','Callback',{@PC.XYCluster, 'nocut'});                uimenu(hm,'label','TwoCluster Space','Callback',{@PC.XYCluster, 'twoplot'});                uimenu(hm,'Label','Optimize angle','Callback',{@PC.XYCluster, 'bestangle'});                uimenu(hm,'Label','Optimize angle (quick)','Callback',{@PC.XYCluster, 'quickangle'});                uimenu(hm,'Label','replot','Callback',{@PC.XYCluster, 'replot'});                uimenu(hm,'Label','revert','Callback',{@PC.XYCluster, 'revert'});                uimenu(hm,'Label','replot with GM ids','Callback',{@PC.XYCluster, 'replotgm'});                uimenu(hm,'Label','&Density','Callback',{@PC.OptionMenu, 1});                uimenu(hm,'Label','Scale Density','Callback',{@PC.OptionMenu, 'scaledensity'});                uimenu(hm,'Label','Use Auto','Callback',{@PC.OptionMenu, 'useautoclusters'});                bp = [0.01 0.01 0.06 0.05];                uicontrol(f,'style','pushbutton','string','AllEx','Units','Normalized','Position',bp,'Tag','AllExptButton',...            'value',0,'callback',{@PC.PlotMenu, 'probes', 'AllprobeXY'});            bp(1) = bp(1)+bp(3);            bp(3) = 0.1;            uicontrol(f,'style','pushbutton','string','AllProbes','Units','Normalized','Position',bp,'Tag','AllExptButton',...            'value',0,'callback',{@PC.PlotMenu, 'probes', 'AllXY'});            bp(1) = bp(1)+bp(3);            bp(3) = 0.1;            uicontrol(f,'style','pushbutton','string','->AllVPcs','Units','Normalized','Position',bp,'Tag','FullVButton',...            'value',0,'callback',{@PC.GuiMenu, 'CallAllVPcs'});                tmp.parentfig = DATA.toplevel;                set(f, 'KeyPressFcn',{@PC.XYKeyPressed,3},'Keyreleasefcn',{@PC.KeyReleased, 3});                set(f,'UserData',DATA.toplevel);        elseif strcmp(tag,DATA.tag.rateseq)                hm = uimenu(f,'Label','&Options','Tag','Options');                uimenu(hm,'Label','&Exclude Selected Trials (current cluster)','Callback',{@PC.OptionMenu, 'excludecurrent'});                uimenu(hm,'Label','&Scroll This Expt/Probe','Callback',{@PC.RateMenu, 'spool'});                uimenu(hm,'Label','&XY sequence plot','Callback',{@PC.RateMenu, 'xyseq'});                uimenu(hm,'Label','Zoom Out &Horizontal (-)','Callback',{@PC.RateMenu, 'hzoomout'});                uimenu(hm,'Label','Zoom Out &Vertical','Callback',{@PC.RateMenu, 'vzoomout'});                uimenu(hm,'Label','Zoom &Out','Callback',{@PC.RateMenu, 'zoomout'});                uimenu(hm,'Label','Zoom In Horizontal (&+)','Callback',{@PC.RateMenu, 'hzoomin'});                uimenu(hm,'Label','Zoom &In (Shift+)','Callback',{@PC.RateMenu, 'zoomin'});                sm = uimenu(hm,'Label','&Expts','Tag','ExptMarkMenu');                PC.AddExptList(sm, 'selectexpts', DATA)                X.toplevel = DATA.toplevel;                set(f,'UserData',X);        elseif strcmp(tag,DATA.tag.xyseq)                hm = uimenu(f,'Label','&Options','Tag','Options');                uimenu(hm,'Label','&Density','Callback',{@PC.PlotMenu, 'xyseq', 'density'});                set(f,'UserData', DATA.toplevel);        elseif strcmp(tag,DATA.tag.clusters)            setappdata(f,'ParentFig', DATA.toplevel);            hm = uimenu(f,'Label','&Plot','Tag','Plot');            sm = uimenu(hm,'Label','RateCheck');            uimenu(sm,'Label','FanoF-C.V.','Callback',{@PC.RatePlotMenu, 'cv'});            uimenu(sm,'Label','FanoF-Skew','Callback',{@PC.RatePlotMenu, 'skew'});            uimenu(sm,'Label','Image','Callback',{@PC.RatePlotMenu, 'image'});            sm = uimenu(hm,'Label','XY/Spks','Tag','TrialMenu');            uimenu(sm,'Label','SelectedXY+Spks','Callback',{@PC.PlotMenu, 'clusters', 'spksxy'});            uimenu(sm,'Label','SelectedXY','Callback',{@PC.PlotMenu, 'probes', 'SelectXY'});            uimenu(sm,'Label','SelectedSpks','Callback',{@PC.PlotMenu, 'probes', 'selectspks'});       else            set(f,'UserData', DATA.toplevel);        end        setappdata(f,'ParentFigure',DATA.toplevel);        Figpos = getappdata(DATA.toplevel,'Figpos');        if isfield(Figpos,tag)            set(f,'position',Figpos.(tag)(1:4));        end    end    