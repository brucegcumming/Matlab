 function [voffset, ylim] = SetVOffset(DATA, AllSpikes, e, setprobe) % voffset = SetVOffset(DATA, AllSpikes, e,  set offsets so that channels % don't overlap (too much) % ..., setprobe) 4th argument means set for this probe using xch  ylim = []; if nargin ==3     setprobe = 0; end if isfield(AllSpikes,'xchans')     setprobe = AllSpikes.probe; end if isempty(AllSpikes)     voffset = [1:DATA.nprobes] .* 2; %? could use meanspiek - get values at startup elseif setprobe > 0 &&  (isfield(AllSpikes,'xchans') || iscell(AllSpikes) && isfield(AllSpikes{e,setprobe},'xchans'))     if isfield(AllSpikes,'xchans')         X = AllSpikes;     else         X = AllSpikes{e,setprobe};     end     voffset(setprobe) = diff(X.VRange);     for j = 1:length(X.xchans)         voffset(X.xchans(j)) = diff(X.xVrange);     end     voffset = cumsum(voffset);     voffset = voffset - voffset(setprobe);     vmaxs(setprobe)  = X.VRange(2);     vmins(setprobe)  = X.VRange(1);     for j = 1:length(X.xchans)        vmins(X.xchans(j)) = voffset(X.xchans(j)) + X.xVrange(1);        vmaxs(X.xchans(j)) = voffset(X.xchans(j)) + X.xVrange(2);     end     voffset = voffset * 0.7;     allprobes = [X.xchans setprobe];     ylim(1) = min(vmins(allprobes)) .* 0.7;     ylim(2) = max(vmaxs(allprobes)) .* 0.7; elseif iscell(AllSpikes)     maxv = CellToMat(AllSpikes(e,:),'VRange');     xch = CellToMat(AllSpikes(e,:),'xchans');     if isempty(maxv)         voffset = [1:DATA.nprobes] .* 2; %? could use meanspiek - get values at startup     else         voffset =  cumsum(cat(1,maxv(2:end,2), maxv(end,2))) - cumsum(maxv(:,1));         if length(voffset) < max(xch(:))             X = AllSpikes{e,length(voffset)};             if isfield(X,'xVrange')                 voffset(max(xch(:))) = max(voffset) + diff(X.xVrange);             else                 voffset(max(xch(:))) = max(voffset) + 2.*X.xmaxv; %? 2* is too much?             end         end         voffset = voffset * 0.7;     end else     voffset(setprobe) = diff(AllSpikes.VRange);     voffset(setprobe+1:DATA.nprobes) = voffset(setprobe); end