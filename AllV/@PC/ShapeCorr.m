function xc = ShapeCorr(P,Q, varargin)testdelays = 0; %allow for different time allignment +- n samplesj = 1;while j <= length(varargin)    if strncmpi(varargin{j},'delays',5)        if length(varargin) > j && isnumeric(varargin{j})            j = j+1;            testdelays = varargin{j};        else            testdelays = 5;        end    end    j = j+1;endif ~isfield(P,'MeanSpike') || ~isfield(Q,'MeanSpike')    xc = NaN;    return;end    for j = 1:testdelays        xc = corrcoef(P.MeanSpike.ms(:,1:end-(j-1)),Q.MeanSpike.ms(:,j:end));        xcs(j) = xc(1,2);    end    for j = -testdelays:-1        xc = corrcoef(P.MeanSpike.ms(:,-j:end),Q.MeanSpike.ms(:,1:end+(j+1)));        xcs(testdelays-j) = xc(1,2);    end    pl = size(P.MeanSpike.ms,2);    ql = size(Q.MeanSpike.ms,2);    if length(P.MeanSpike.ms(:)) == length(Q.MeanSpike.ms(:))        xc = corrcoef(P.MeanSpike.ms(:),Q.MeanSpike.ms(:));    elseif pl > ql %should really match peak or something here.         x = P.MeanSpike.ms(:,1:ql);        xc = corrcoef(x(:),Q.MeanSpike.ms(:));    else        x = Q.MeanSpike.ms(:,1:pl);        xc = corrcoef(P.MeanSpike.ms(:),x(:));    end            xc = xc(1,2);    if testdelays > 0 && max(xcs) > xc        xc = max(xcs);    end