function [stopped, h] = SpoolSpikes(DATA, pos, varargin)    useids = [];    args = {};    setlist = 1;    autospikes = 0;    j = 1;    while j <= length(varargin)        if strncmpi(varargin{j},'auto',4)            autospikes = 1;        elseif strncmpi(varargin{j},'ids',3)            j = j+1;            useids = varargin{j};        else            args = {args{:} varargin{j}};        end        j = j+1;    end        stopped = 0;    e = pos(1);    p = pos(2);    eid = DATA.exptid(e);    DATA.usegmcid = 0;    Expts = getappdata(DATA.toplevel,'Expts'); %Expts{j} is exptno j, not expid(j)    DATA.Expt = Expts{eid};    if ~isfield(DATA.Expt,'Trials')        DATA.plotspk.bytrial = 0;    else        DATA.plotspk.bytrial = 1;        Trials = Expts{eid}.Trials;    end    DATA.voffset = [1:DATA.nprobes] .*2;    if autospikes        Clusters = getappdata(DATA.toplevel,'AutoClusters');        C = Clusters{e}{p};        [mnk, a, b] = GetMonkeyName(DATA.name);        name = [DATA.name '/AutoSpikes/' mnk b '.p' num2str(p)  't' num2str(floor(DATA.exptid(e))) '.mat'];        AllSpikes{e,p} = ReadSpikeFile(name,'allprobes');    else        Clusters = getappdata(DATA.toplevel,'Clusters');        C = Clusters{e}{p};        AllSpikes = PC.CheckAllSpikes(DATA, e, p,'allprobes');    end    if ~isfield(AllSpikes{e,p},'xvalues')        chspk = [p-DATA.nprobespool:p+DATA.nprobespool];        chspk = chspk(chspk > 0 & chspk <= DATA.nprobes & chspk ~= p);        AllSpikes = PC.CheckAllSpikes(DATA, e, [chspk],'allprobes');        needprobe = chspk;    else        chspk = [p AllSpikes{e,p}.xchans];        needprobe = [];    end    maxv = CellToMat(AllSpikes(e,:),'VRange');    if size(maxv,1) < max(chspk)        for j = 1:length(AllSpikes{e,p}.xchans)            c = AllSpikes{e,p}.xchans(j);            v = AllSpikes{e,p}.xmaxv;            maxv(c,1) = -v;            maxv(c,2) = v;                    end    end    DATA.voffset = PC.SetVOffset(DATA, AllSpikes, e,p);    voff = (DATA.voffset - DATA.voffset(p));    pa = min([chspk p]);    pb = max([chspk p]);    %[va, pa] = min(voff);    %[vb, pb] = max(voff);    yl(1) = voff(pa)+maxv(pa,1);    yl(2) = voff(pb)+maxv(pb,2);    Spks(1) = AllSpikes{e,p};    for j = 1:length(needprobe)        if isfield(AllSpikes{e,needprobe(j)},'values')            Spks(1+j).values = AllSpikes{e,needprobe(j)}.values;            Spks(1+j) = CopyFields(Spks(1+j), AllSpikes{e,needprobe(j)},fields(Spks));        else            beep;            mycprintf('red','E%dP%d missing spk values\n',e,needprobe(j));        end    end    for j = 1:length(needprobe)        Spks(j+1).probe = needprobe(j);    end    F = PC.SetFigure(DATA, DATA.tag.spikes,'front');    stopbtn = findobj(F,'Tag','StopSpool');    tic;        if DATA.plotspk.bytrial        if length(useids)        Trials = Trials(useids);        firsttrial = 1;    else        mint = min(cat(1,Spks.times));        useids = find([Trials.TrialStart] > mint-10000);        firsttrial = useids(1);        useids = 1:length(Trials);    end    xcl = PC.FindExcludedTrials(DATA,e,p,1,C);    for j = firsttrial:length(Trials)        if ~ismember(j, xcl) || length(useids) == 1        DATA.currenttrial = useids(j);        ispk = find(C.t > Trials(j).Start(1)./10000 & C.t < Trials(j).End(end)./10000);        h = PC.PlotSpikes(DATA, pos, ispk, Spks, C, 'fixy',yl,args{:});        drawnow;        end        stopped = get(stopbtn,'value');        if stopped            set(stopbtn,'value',0);            stopped = 1;            return;        end    end    else        spkset = 1:100;        j = 0;        while j < length(Spks.values)            ispk = spkset + j;            h = PC.PlotSpikes(DATA, pos, ispk, Spks, C, 'fixy',yl,args{:});            drawnow;            stopped = get(stopbtn,'value');            if stopped                set(stopbtn,'value',0);                stopped = 1;                return;            end            j = j+spkset(end);        end    end    toc;    clear AllSpikes;    clear Clusters;    if length(useids) ==1 || setlist        PC.SetTrialList(DATA, C, useids);    end    set(DATA.toplevel,'UserData',DATA);    