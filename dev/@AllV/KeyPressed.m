function KeyPressed(src, ks)DATA = GetDataFromFig(src);spk = [0 0];if ~isfield(DATA,'currenttrial') %keypress before ready.    return;endoldf = gcf;if ~isfield(DATA,'spklist') || isempty(DATA.spklst)    DATA.spklst = 1:100;endw = DATA.spksperview;nt = DATA.currenttrial;if strmatch(ks.Key,'delete')     if isfield(DATA,'mousept')    DeleteCluster(mousept.cluster, a);    mousept.mode = 0;    mousept.angle = 0;    if mousept.lasth & ishandle(mousept.lasth)        delete(mousept.lasth);    end    endelseif strmatch(ks.Key,'rightarrow')    DATA.stopspool = 1;    w = DATA.spksperview;    spk = minmax(DATA.spklst);    nt = DATA.currenttrial+1;    spk(1) = spk(2);    spk(2) = spk(2)+w;elseif strmatch(ks.Key,'leftarrow')    DATA.stopspool = 1;    w = DATA.spksperview;    spk = minmax(DATA.spklst);    nt = DATA.currenttrial-1;    spk(2) = spk(1);    spk(1) = spk(1)-w;elseif strmatch(ks.Key,'downarrow')    DATA.stopspool = 1;    DATA.spklst = DATA.spklst+1;    AllV.PlotSpikes(DATA,DATA.spklst(1),'fixy');    spk = [0 0];elseif strmatch(ks.Key,'uparrow')    DATA.stopspool = 1;    DATA.spklst = DATA.spklst-1;    AllV.PlotSpikes(DATA,DATA.spklst(1),'fixy');    spk = [0 0];elseif strmatch(ks.Key,'add')    it = findobj(src,'Tag','Clusterid');    c = get(it,'value');    set(it,'value',c+1);elseif strmatch(ks.Key,'subtract')    it = findobj(src,'Tag','Clusterid');    c = get(it,'value');    if c > 1     set(it,'value',c-1);    endelseif strmatch(ks.Key,'space')    DATA.stopspool = 1;elseif ks.Key == 'r'    mousept.angle = mousept.angle+0.02;    mousept.mode = 10;    if mousept.lasth & ishandle(mousept.lasth)    delete(mousept.lasth);    end   mousept = myellipse(mousept,[0 0; 0 0 ]);endspklst = [];if DATA.plotspk.bytrial || DATA.plotspk.allprobes    DATA.currenttrial = AllV.PlotTrialSpikes(DATA,nt,'setcontext');    AllV.FinishSpikePlot(DATA);    set(DATA.toplevel,'UserData',DATA);    return;endif spk(2) > 0 && spk(1) < DATA.nevents    spklst = spk(1):spk(2);    DATA.spklst = spklst;    AllV.PlotSpikes(DATA,DATA.spklst,'fixy');    set(DATA.toplevel,'UserData',DATA);end