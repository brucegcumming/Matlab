function [F, isnew] = SetFigure(lb, varargin)%[F, isnew] = AllV.SetFigure(tag, DATA, ..)%sets figrea according to tag 'tag' and%creates menus etc    onoff = {'off' 'on'};       PCDATA = [];   toptag = 'PCs';   DATA.interactive = 0;   if length(varargin) && isstruct(varargin{1})       DATA = varargin{1};       toptag = DATA.tag.top;       if length(varargin) > 1           varargin = varargin(2:end);       else           varargin = {};       end   end   if DATA.interactive < 0       F = 0;       isnew = 0;       return;   end   if DATA.interactive == 0       [F, isnew] = GetFigure(lb,'noforce',varargin{:});   else       [F, isnew] = GetFigure(lb,'noforce',varargin{:});   end    if strcmp(lb,DATA.tag.tmplscore)     if isnew         setappdata(F,'ParentFigure',DATA.toplevel);         hm = uimenu(F,'Label','Plot','Tag','PlotMenu');         uimenu(hm,'Label','Dots','Callback',{@AllV.XYplot, 'Dots'});         uimenu(hm, 'label','Density','Callback',{@AllV.XYplot, 'none'});         uimenu(hm, 'label','None','Callback',{@AllV.XYplot, 'density'});     end     AllV.AddParameterMenu(F,@AllV.XYplot, 'X');     AllV.AddParameterMenu(F,@AllV.XYplot, 'Y'); end   if isnew    if strcmp(lb,toptag)        DATA.toplevel = F;        if exist(DATA.layoutfile) && DATA.readlayout            load(DATA.layoutfile);            setappdata(F,'Figpos',Figpos);            if isfield(Figpos,lb)                set(F,'Position',Figpos.(lb));            end        elseif DATA.readlayout            fprintf('Cant read %s\n', DATA.layoutfile)        end        hm = uimenu(F,'Label','&Cluster','Tag','ClusterMenu');        sm = uimenu(hm,'Label','Draw &Ellipse','Tag','EllipseMenu');        uimenu(sm,'Label','Cluster &1','foregroundcolor',DATA.colors{2},'Callback',{@AllV.PCCluster, 'Ellipse1'},'accelerator','1');        uimenu(sm,'Label','Cluster &2','foregroundcolor',DATA.colors{3},'Callback',{@AllV.PCCluster, 'Ellipse2'},'accelerator','2');        uimenu(sm,'Label','Cluster &3','foregroundcolor',DATA.colors{4},'Callback',{@AllV.PCCluster, 'Ellipse3'},'accelerator','3');        uimenu(sm,'Label','Cluster &4','foregroundcolor',DATA.colors{5},'Callback',{@AllV.PCCluster, 'Ellipse4'},'accelerator','4');        uimenu(sm,'Label','Cluster &5','foregroundcolor',DATA.colors{6},'Callback',{@AllV.PCCluster, 'Ellipse5'},'accelerator','5');        uimenu(sm,'Label','Cluster &6','foregroundcolor',DATA.colors{7},'Callback',{@AllV.PCCluster, 'Ellipse6'},'accelerator','6');        sm = uimenu(hm,'Label','&Clear Cluster','Tag','EllipseMenu');        uimenu(sm,'Label','Clear Cluster &2','foregroundcolor',DATA.colors{3},'Callback',{@AllV.PCCluster, 'Clear2'});        b = uimenu(sm,'Label','Clear Cluster &3','foregroundcolor',DATA.colors{4},'Callback',{@AllV.PCCluster, 'Clear3'});        uimenu(sm,'Label','Clear Cluster &4','foregroundcolor',DATA.colors{5},'Callback',{@AllV.PCCluster, 'Clear4'});        uimenu(sm,'Label','Clear Cluster &5','foregroundcolor',DATA.colors{6},'Callback',{@AllV.PCCluster, 'Clear5'});        uimenu(sm,'Label','Clear Cluster &6','foregroundcolor',DATA.colors{7},'Callback',{@AllV.PCCluster, 'Clear6'});        uimenu(hm,'Label','&Use This Cluster','Callback',{@AllV.PCCluster, 34});%        uimenu(hm,'Label','VarE Ellipse','Callback',{@AllV.PCCluster, 2});        uimenu(hm,'Label','&Density','Callback',{@AllV.PCCluster, 4},'Tag','Density');        uimenu(hm,'Label','Scale Density','Callback',{@AllV.MiscMenu,'scaledensity'},'Tag','ScaleDensity');        sm = uimenu(hm,'Label','&Mark','Tag','MarkMenu');        uimenu(sm,'Label','&Good','Callback',{@AllV.PCCluster, 'markgood'},'Tag','MarkGood');        uimenu(sm,'Label','&Bad Probe','Callback',{@AllV.PCCluster, 'markbadprobe'},'Tag','MarkBad');        uimenu(sm,'Label','&Bad Expt FullV','Callback',{@AllV.PCCluster, 'markbadexpt'},'Tag','MarkBad');        uimenu(sm,'Label','&Duplicate Probe','Callback',{@AllV.PCCluster, 'markduplicateprobe'},'Tag','MarkDup');        uimenu(sm,'Label','Good &MU','Callback',{@AllV.PCCluster, 'markmugood'},'Tag','MarkMu');%        uimenu(sm,'Label','&Good','Callback',{@AllV.PCCluster, 'markgood'},'Tag','MarkGood');        uimenu(hm,'Label','&ReDraw','Callback',{@AllV.PCCluster, 3});        uimenu(hm,'Label','&Template','Callback',{@AllV.PCCluster, 5});        uimenu(hm,'Label','StdTemplate','Callback',{@AllV.PCCluster, 32});        uimenu(hm,'Label','PC &Line','Callback',{@AllV.PCCluster, 'Ellipse0'},'accelerator','L');        sm = uimenu(hm,'Label','E&xtras','Tag','ClusterMenu');        uimenu(sm,'Label','&Flip Line Criterion','Callback',{@AllV.PCCluster, 'flipsign'});        uimenu(sm,'Label','PC &Line2','Callback',{@AllV.PCCluster, 11});        uimenu(sm,'Label','&Optimize Cluster','Callback',{@AllV.PCCluster, 18});        uimenu(sm,'Label','&Iterate Fit','Callback',{@AllV.PCCluster, 'iteratefit'});        uimenu(sm,'Label','&PlotExpt (once)','Callback',{@AllV.PlotResult, 'plotexpt'});        uimenu(sm,'Label','&AutoMatic Cut','Callback',{@AllV.PCCluster, 19});        uimenu(sm,'Label','&GaussMeans','Callback',{@AllV.PCCluster, 22});        uimenu(sm,'Label','&Xcorr (clusters)','Callback',{@AllV.CalcXcorr, 'clusters'});        uimenu(sm,'Label','Xcorr &Probes','Callback',{@AllV.CalcXcorr, 'probes'});        uimenu(sm,'Label','PC on &dvdt','Callback',{@AllV.PCCluster, 'dvdtpc'});        uimenu(sm,'Label','&Quick AutoCut','Callback',{@QuickAutoCut});        sm = uimenu(hm,'Label','N-D','Tag','ClusterMenu');        uimenu(sm,'Label','BestSpace','Callback',{@AllV.PCCluster, 23});        uimenu(sm,'Label','BestSpace (scratch)','Callback',{@AllV.PCCluster, 26});        uimenu(sm,'Label','BestSpace (2 cells)','Callback',{@AllV.PCCluster, '2cells'});        uimenu(sm,'Label','BestSpace (3 cells)','Callback',{@AllV.PCCluster, '3cells'});        uimenu(sm,'Label','BestSpace (4 cells)','Callback',{@AllV.PCCluster, '4cells'});        uimenu(sm,'Label','AllSpaces (6 clusters)','CallBack',{@AllV.PCCluster, 'all6cells'});        uimenu(sm,'Label','K means','Callback',{@AllV.PCCluster, 28});        uimenu(sm,'Label','Use ND clid','Callback',{@AllV.PCCluster, 29});        uimenu(sm,'Label','TemplateSpace','Callback',{@AllV.PCCluster, 'NDTemplate'});        uimenu(sm,'Label','TemplateSpace N cell','Callback',{@AllV.PCCluster, 'NCellTemplate'});        uimenu(sm,'Label','StdTemplateSpace','Callback',{@AllV.PCCluster, 'NDStdTemplate'});        uimenu(sm,'Label','PCSpace','Callback',{@AllV.PCCluster, 31});        uimenu(sm,'Label','PCSpace 2 cells','Callback',{@AllV.PCCluster, 'PCtwo'});        uimenu(sm,'Label','PCSpace 3 cells','Callback',{@AllV.PCCluster, 'PCthree'});        uimenu(sm,'Label','PCSpace 4 cells','Callback',{@AllV.PCCluster, 'PC4'});        uimenu(sm,'Label','PCSpace Multiple Cells','Callback',{@AllV.PCCluster, 'PCmultiple'});        sm = uimenu(hm,'Label','&GMM','Tag','GMMMenu');        uimenu(sm,'Label','Recalc without cell','Callback',{@AllV.GMMmenu, 'refit'});        uimenu(sm,'Label','&Plot GMM components','Callback',{@AllV.GMMmenu, 'setplot'});        uimenu(sm,'Label','Split C&1','Callback',{@AllV.GMMmenu, 'split1'});        uimenu(sm,'Label','Split C&2','Callback',{@AllV.GMMmenu, 'split2'});        uimenu(sm,'Label','Split C&3','Callback',{@AllV.GMMmenu, 'split3'});        uimenu(sm,'Label','Split C&4','Callback',{@AllV.GMMmenu, 'split4'});        uimenu(sm,'Label','&Merge','Callback',{@AllV.GMMmenu, 'merge'});        uimenu(sm,'Label','&Add','Callback',{@AllV.GMMmenu, 'add'});        uimenu(sm,'Label','&Undo','Callback',{@AllV.GMMmenu, 'undo'});        sm = uimenu(sm,'Label','&Refit');        uimenu(sm,'Label','&Current Space','Callback',{@AllV.GMMmenu, 'refit current'});        uimenu(sm,'Label','&Template Space','Callback',{@AllV.GMMmenu, 'refit template'});        sm = uimenu(hm,'Label','PCs','Tag','ClusterMenu');        uimenu(sm,'Label','Recalc without cell','Callback',{@AllV.PCCluster, 33});        uimenu(sm,'Label','csd','Callback',{@SetOption},'tag','csd');        uimenu(sm,'Label','dvdy','Callback',{@SetOption},'tag','dvdy');        uimenu(sm,'Label','dvdt','Callback',{@SetOption},'tag','dvdt');                sm = uimenu(hm,'Label','&Plot','Tag','ClusterMenu');        uimenu(sm,'Label','&PCS','Callback',{@AllV.PCCluster, 9});        uimenu(sm,'Label','&ADC','Callback',{@AllV.PCCluster, 10});        uimenu(sm,'Label','&Templates','Callback',{@AllV.PCCluster, 14});        uimenu(sm,'Label','Templates&2','Callback',{@AllV.PCCluster, 15});        uimenu(sm,'Label','&dvdt','Callback',{@AllV.PCCluster, 20});        uimenu(sm,'Label','&Other Bits','Callback',{@AllV.PCCluster, 'plotother'});        uimenu(sm,'Label','Test Scores','Callback',{@AllV.SetPlot, 'testscore'});        uimenu(sm,'Label','All Clusters','Callback',{@AllV.SetPlot, 'allspace'});        if ~isempty(strfind(path,'FastICA'))            uimenu(sm,'Label','&ICA','Callback',{@AllV.PCCluster, 'plotica'});        end        uimenu(sm,'Label','Cell &List','Callback',{@AllV.MiscMenu, 'plotcelllist'});        uimenu(sm,'Label','&Cluster','Callback',{@AllV.PCCluster, 24});        uimenu(sm,'Label','&Histogram','Callback',{@AllV.PCCluster, 26});        uimenu(sm,'Label','use gmcids','Callback',{@AllV.SetOption, 'usegmcid'},'tag','usegmcid');        uimenu(sm,'Label','&ISI Hist','Callback',{@AllV.PlotISI, 1});        uimenu(sm,'Label','&ISI Sequence','Callback',{@AllV.PlotISI, 2});        uimenu(sm,'Label','X&Y Sequence','Callback',{@AllV.PlotMenu, 'xyseq'});        uimenu(sm,'Label','&Rate Sequence','Callback',{@AllV.PlotMenu, 'rateseq'});        uimenu(sm,'Label','&Expt','Callback',{@AllV.PlotResult, 1});        sm = uimenu(sm,'Label','&xCorr Plots','Tag','ClusterMenu');        uimenu(sm,'Label','Show &CrossCorr adjacent probes','Callback',{@AllV.PlotMenu, 'xcorrprobes'});        uimenu(sm,'Label','CrossCorr All &Probes','Callback',{@AllV.PlotMenu, 'xcorrallprobes'});        uimenu(sm,'Label','CrossCorr &Nearby Probes','Callback',{@AllV.PlotMenu, 'xcorradjacent'});        uimenu(sm,'Label','&Xcorr (clusters)','Callback',{@AllV.CalcXcorr, 'clusters'});        uimenu(sm,'Label','Xcorr &Probes','Callback',{@AllV.CalcXcorr, 'probes'});                sm = uimenu(hm,'Label','Axes:tight','Tag','ClusterMenu');        uimenu(sm,'Label','100%','Callback',{@AllV.PCCluster, 100});        uimenu(sm,'Label','99%','Callback',{@AllV.PCCluster, 99});        sm = uimenu(hm,'Label','PlotClusters','Tag','PlotClusters');        uimenu(sm,'Label','SpkTimes','Callback',{@AllV.PlotClusters, 1});        uimenu(sm,'Label','xCorr','Callback',{@AllV.PlotClusters, 2});        uimenu(sm,'Label','Quality','Callback',{@AllV.PlotClusters, 3});        uimenu(hm,'Label','Delete','Callback',{@AllV.PCCluster, 17});        uimenu(hm,'Label','Revert','Callback',{@AllV.PCCluster, 21});        uimenu(hm,'Label','Save (&quick)','Callback',{@AllV.PCCluster, 12});        uimenu(hm,'Label','&Save Spikes','Callback',{@AllV.PCCluster, 25});        uimenu(hm,'Label','Save To Def&initions','Callback',{@AllV.PCCluster, 'savedef'},'accelerator','i');        uimenu(hm,'Label','Quantify Quick Clusters','Callback',{@AllV.PCCluster, 'quantifyquick'});        sm = uimenu(hm,'Label','&Window Layout/Setting','Tag','LayoutMenu');        uimenu(sm,'Label','Windows to &Front','Callback',{@AllV.MiscMenu, 'tofront'});        uimenu(sm,'Label','&Save Layout','Callback',{@AllV.MiscMenu, 'savelayout'});        uimenu(sm,'Label','&Save Default Layout','Callback',{@AllV.MiscMenu, 'savedefaultlayout'});        uimenu(sm,'Label','&Load','Callback',{@AllV.MiscMenu, 'loadlayout'});        uimenu(sm,'Label','Load &Layout','Callback',{@AllV.MiscMenu, 'loadlayout'});        uimenu(sm,'Label','&Preferences','Callback',{@AllV.MiscMenu, 'preferences'});        uimenu(sm,'Label','Save &Config','Callback',{@AllV.MiscMenu, 'saveconfig'});        uimenu(sm,'Label','Save Config as &Default','Callback',{@AllV.MiscMenu, 'savedefaultconfig'});        uimenu(sm,'Label','Load &Configuration','Callback',{@AllV.MiscMenu, 'loadconfig'});                        hm = uimenu(F,'Label','&Probes','Tag','ProbeMenu');        uimenu(hm,'Label','&Next','Tag','NextButton','Callback',{@AllV.ChangeProbe, 'next'});        uimenu(hm,'Label','&QuickSave+Next','Tag','SaveNextButton','Callback',{@AllV.ChangeProbe, 'quicksave'});        uimenu(hm,'Label','&Prev','Tag','NextButton','Callback',{@AllV.ChangeProbe, 'prev'});        uimenu(hm,'Label','&Save+Next','Tag','SaveNextButton','Callback',{@AllV.ChangeProbe, 'save'});        uimenu(hm,'Label','1','Callback',{@AllV.ProbeMenu, 1});        uimenu(hm,'Label','3','Callback',{@AllV.ProbeMenu, 2});        uimenu(hm,'Label','5','Callback',{@AllV.ProbeMenu, 3});        uimenu(hm,'Label','dvdt','Callback',{@AllV.ProbeMenu, 4});        uimenu(hm,'Label','csd','Callback',{@AllV.ProbeMenu, 5});        uimenu(hm,'Label','dvdy','Callback',{@AllV.ProbeMenu, 'dvdy'});        uimenu(hm,'Label','select','Callback',{@AllV.ProbeMenu, 'selecttxt'});        uimenu(hm,'Label','selector gui','Callback',{@AllV.ProbeMenu, 'select'});        sm =  uimenu(hm,'Label','S&witch To','Tag','ProbeSwitchMenu');        pchars = ['1':'9' '0' 'a':'z'];        for j = 1:DATA.allnprobes            if j < 10            uimenu(sm,'Label',['&' num2str(j)] ,'Callback',{@AllV.ChangeProbe, j});            elseif j <= length(pchars)                uimenu(sm,'Label',[num2str(j) ' (&'  pchars(j) ')'] ,'Callback',{@AllV.ChangeProbe, j});            else                uimenu(sm,'Label', num2str(j) ,'Callback',{@AllV.ChangeProbe, j});            end        end        sm =  uimenu(hm,'Label','Switch &Mode','Tag','ProbeModeMenu');        a(1) = uimenu(sm,'Label','usecluster (quicker)','CallBack',{@AllV.ProbeMenu, 'usecluster'},'tag','usecluster');        a(2) = uimenu(sm,'Label','Reclassify','CallBack',{@AllV.ProbeMenu, 'reclassify'},'tag','reclassify');        a(3) = uimenu(sm,'Label','Reapply','CallBack',{@AllV.ProbeMenu, 'reapply'},'tag','reapply');        a(4) = uimenu(sm,'Label','AutoCut','CallBack',{@AllV.ProbeMenu, 'autocut'},'tag','autocut');          a(5) = uimenu(sm,'Label','Simple cut (quickest)','CallBack',{@AllV.ProbeMenu, 'simple'},'tag','simple');        j = strmatch(DATA.probeswitchmode,{'usecluster' 'reclassify' 'reapply' 'autocut' 'simple'});        if length(j) == 1            set(a(j),'Checked','on');        end        hm = uimenu(F,'Label','&Options','Tag','OptionMenu');        sm = uimenu(hm,'Label','When &Cutting','Tag','CutOptionMenu');        uimenu(sm,'Label','&Quick','Tag','NextButton','Callback',{@AllV.OptionMenu, 'quickest'},'Tag','quickest');        uimenu(sm,'Label','+&GM for 1d','Tag','NextButton','Callback',{@AllV.OptionMenu, 'fit1cut'},'Tag','fit1cut');        uimenu(sm,'Label','+&2Gauss Fit','Tag','NextButton','Callback',{@AllV.OptionMenu, 'fit2gauss'},'Tag','fit2gauss');        uimenu(sm,'Label','+&Drop Index','Tag','NextButton','Callback',{@AllV.OptionMenu, 'dropi'},'Tag','dropi');        uimenu(sm,'Label','+&Calc Mean','Tag','NextButton','Callback',{@AllV.OptionMenu, 'mean'},'Tag','mean');        uimenu(sm,'Label','Do all fits','Tag','NextButton','Callback',{@AllV.OptionMenu, 'fitallcut'},'Tag','fitallcut');        uimenu(sm,'Label','Plot Spikes','Tag','NextButton','Callback',{@AllV.OptionMenu, 'plotspikes'},'Tag','plotspikes');        uimenu(hm,'Label','Ne&w FullV','Tag','NextButton','Callback',{@AllV.OptionMenu, 'newfullv'},'Tag','NewFullV');        uimenu(hm,'Label','&Next FullV','Tag','NextButton','Callback',{@AllV.OptionMenu, 'nextfullv'},'Tag','NextFullV');        uimenu(hm,'Label','&Prev FullV','Tag','NextButton','Callback',{@AllV.OptionMenu, 'prevfullv'},'Tag','PrevFullV');        sm = uimenu(hm,'Label','When->New FullV','Tag','SwitchOptionMenu');        uimenu(sm,'Label','Check Clusters','Callback',{@AllV.OptionMenu, 'checkclusters'},...            'Tag','checkclusters','checked',onoff{DATA.checkclusters+1});        uimenu(sm,'label','Summary Plot','Callback',{@AllV.OptionMenu, 'summary'},...            'Tag','summary');        sm = uimenu(hm,'Label','Auto','Tag','AutoMenau');        uimenu(sm,'Label','Advance Probe When Save','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','advanceprobe',...            'checked',onoff{1+DATA.auto.advanceprobe});        uimenu(sm,'Label','Advance Expt When Save','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','advanceexpt');        uimenu(sm,'Label','Save when define ref','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','saveref');        uimenu(sm,'Label','Xcorr for multiple clusters','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','checkxcorr');        uimenu(sm,'Label','Re-use last  cluster for new expt','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','uselastcluster');        uimenu(sm,'Label','Replot when change cluster','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','replotcluster');        uimenu(sm,'Label','Check for Missing clusters','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','checkcluster');        uimenu(sm,'Label','Show XY for saved clusters','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','showxysaved');        uimenu(sm,'Label','QuickCut new empty clsuters','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','quickcut');        uimenu(sm,'Label','Calc Trigger Stats','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','trigstats');%        h = uimenu(sm,'Label','Include Details in quick save','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','savexy');        uimenu(sm,'Label','Backup Cluster When Save','Callback',{@AllV.OptionMenu, 'autoopt'},'Tag','backupcluster');        xm = uimenu(hm,'Label','Quick Save')        h = uimenu(xm,'label','Include Spikes','Callback',{@AllV.OptionMenu, 'quickopts'},...            'Tag','QuickSpikes');        set(h,'checked',onoff{1+DATA.quicksave.QuickSpikes});        h = uimenu(xm,'label','Include Details','Callback',{@AllV.OptionMenu, 'quickopts'},...            'Tag','QuickDetails');        set(h,'checked',onoff{1+DATA.quicksave.QuickDetails});        xm = uimenu(hm,'Label','Summary Plot')        uimenu(xm,'label','Spks + XY','Callback',{@AllV.OptionMenu, 'plotsummary'},...            'Tag','plotsummary');        uimenu(xm,'label','XY plots','Callback',{@AllV.OptionMenu, 'xysummary'},...            'Tag','xysummary');        uimenu(xm,'label','Spikes','Callback',{@AllV.OptionMenu, 'spksummary'},...            'Tag','spksummary');        uimenu(xm,'label','Mean','Callback',{@AllV.OptionMenu, 'meansummary'},...            'Tag','meansummary');        uimenu(xm,'label','Label With Id','Callback',{@AllV.OptionMenu, 'labelwithid'},...            'Tag','labelwithid','checked',onoff{1+DATA.plot.labelwithid});        uimenu(hm,'Label','&Retrigger','Tag','NextButton','Callback',{@AllV.OptionMenu, 'retrigger'},'Tag','Retrigger');        uimenu(hm,'Label','&Spool Spikes','Tag','SpoolSpikes','Callback',{@AllV.OptionMenu, 'spoolspikes'});        uimenu(hm,'Label','Co&mment','Tag','Commnent','Callback',{@AllV.OptionMenu, 'comment'});        uimenu(hm,'Label','Profiling','Tag','Profiling','Callback',{@AllV.OptionMenu, 'profiling'});                set(F, 'KeyPressFcn',@AllV.PCKeyPressed);        set(F,'CloseRequestFcn',@AllV.exitallv);        PCDATA = DATA;        set(F,'UserDATA',DATA);    else       it = findobj('type','figure','tag',toptag);       PCDATA = get(it,'UserData');    end        if strcmp(lb,'FullV')%            set(F, 'WindowScrollWheelFcn',@AllV.ScrollV);        hm = uimenu(F,'Label','Plot','Tag','ClusterMenu');        uimenu(hm,'Label','1 Probe','Callback',{@AllV.OptionMenu, '1probefullv'});        uimenu(hm,'Label','3 probes','Callback',{@AllV.OptionMenu,'3probefullv'});        uimenu(hm,'Label','5 probes','Callback',{@AllV.OptionMenu, '5probefullv'});        set(F, 'WindowButtonDownFcn',@AllV.FullVButtonPressed);        set(F, 'WindowButtonUpFcn',@AllV.FullVButtonReleased);        set(F, 'WindowScrollWheelFcn',@AllV.ScrollFullV);        set(F,'UserData',DATA.toplevel);    elseif strcmp(lb,'Hist')        DATA.parentfigtag = toptag;        set(F,'UserData',DATA);        set(F, 'KeyPressFcn',@AllV.HistKeyPressed);        set(F, 'WindowButtonDownFcn',@AllV.HistButtonPressed);        set(F, 'WindowButtonMotionFcn',@AllV.HistButtonDragged);        set(F, 'WindowButtonUpFcn',@AllV.HistButtonReleased);        hm = uimenu(F,'Label','Plot','Tag','ClusterMenu');        uimenu(hm,'Label','Dip Criterion','Callback',{@AllV.HistMenu, 1});        uimenu(hm,'Label','mahal/angle','Callback',{@AllV.HistMenu, 2});        uimenu(hm,'Label','Hist Replot','Callback',{@AllV.HistMenu, 3});        uimenu(hm,'Label','Flip Criterion','Callback',{@AllV.HistMenu, 4});    elseif strcmp(lb,'ExptFig')        hm = uimenu(F,'Label','Fit','Tag','ExptFigMenu');        uimenu(hm,'Label','Fit','Callback',{@AllV.ExptFigMenu, 'fit'});        X.toplevel = PCDATA.toplevel;        set(F,'UserData',X);    elseif strcmp(lb,'Clusters')        DATA.parentfigtag =toptag;        hm = uimenu(F,'Label','Plot','Tag','ClusterMenu');        set(F,'UserData',DATA);        uimenu(hm,'Label','Times','Callback',{@AllV.PlotCluster, 1});        uimenu(hm,'Label','xcorr','Callback',{@AllV.PlotCluster, 2});        uimenu(hm,'Label','xcorr adjacent','Callback',{@AllV.PlotCluster, 3});        uimenu(hm,'Label','xcorr 2sep','Callback',{@AllV.PlotCluster, 4});        uimenu(hm,'Label','Quality Scatter','Callback',{@AllV.PlotCluster, 5});        uimenu(hm,'Label','QualityProbes','Callback',{@AllV.PlotCluster, 6});    elseif strcmp(lb,'Spikes')        DATA.parentfigtag = toptag;        set(F,'UserData',DATA);        set(F, 'WindowScrollWheelFcn',@AllV.ScrollSpikes);        set(F, 'KeyPressFcn',@AllV.KeyPressed);        hm = uimenu(F,'Label','&Scroll','Tag','ClusterMenu','ButtonDownFcn',{@AllV.SpikeDraw, 'menu'});        uimenu(hm,'Label','&Spool Spikes','Callback',{@AllV.SpikeDraw, 3});        uimenu(hm,'Label','Spool by Trial','Callback',{@AllV.SpikeDraw, 10},'Tag','PlotByTrial');        uimenu(hm,'Label','More Spikes','Callback',{@AllV.SpikeDraw, 1});        uimenu(hm,'Label','Fewer Spikes','Callback',{@AllV.SpikeDraw, 2});        uimenu(hm,'Label','Spool All Probes','Callback',{@AllV.SpikeDraw, 13});        uimenu(hm,'Label','QuickSpk All Probes','Callback',{@AllV.SpikeDraw, 'allquickspks'});        uimenu(hm,'Label','Mean All Probes','Callback',{@AllV.SpikeDraw, 'allmeans'});        uimenu(hm,'Label','dVdt','Callback',{@AllV.SpikeDraw, 4});        uimenu(hm,'Label','csd','Callback',{@AllV.SpikeDraw, 5});        uimenu(hm,'Label','dvdy','Callback',{@AllV.SpikeDraw, 'dvdy'});        uimenu(hm,'Label','Subtact Trigger','Callback',{@AllV.SpikeDraw, 'subtrigger'});        uimenu(hm,'Label','Subtact mean','Callback',{@AllV.SpikeDraw, 6});        uimenu(hm,'Label','Subtract peak','Callback',{@AllV.SpikeDraw, 7});        uimenu(hm,'Label','Subtract Min','Callback',{@AllV.SpikeDraw, 8});        uimenu(hm,'Label','Main Probe Only','Callback',{@AllV.SpikeDraw, 9});                uimenu(hm,'Label','Exclude Later Spikes','Callback',{@AllV.SpikeDraw, 11});                uimenu(hm,'Label','Exclude Earlier Spikes','Callback',{@AllV.SpikeDraw, 12});                uimenu(hm,'Label','Exclude Selected Trials','Callback',{@AllV.SpikeDraw, 'excludetrials'});                uimenu(hm,'Label','Use All Spikes','Callback',{@AllV.SpikeDraw, 14});                uimenu(hm,'Label','xCorr Selected','Callback',{@AllV.SpikeDraw, 15});                uimenu(hm,'Label','xCorr Adjacent','Callback',{@AllV.SpikeDraw, 'xcorradj'});                uimenu(hm,'Label','xCorr Aall','Callback',{@AllV.SpikeDraw, 'xcorrall'});                uimenu(hm,'Label','Spoolwith mean','Callback',{@AllV.SpikeDraw, 'spoolwithmean'});                hm = uimenu(F,'Label','&Options','Tag','OptionMenu');%        sm = uimenu(hm,'Label','When Cutting','Tag','CutOptionMenu');        sm = hm;        uimenu(sm,'Label','Show Full V','Tag','FullVToggle','Callback',{@AllV.OptionMenu, 'showfullv'});        uimenu(sm,'Label','Include Pre/Post period','Tag','PrePostToggle','Callback',{@AllV.OptionMenu, 'includeprepost'});        hm= uimenu(sm,'Label','Define ADC sample','Tag','ADCSetButton');        if length(DATA.chspk) == 1            uimenu(hm,'Label','#1 (All probes)','Tag','ADCSetButton1' , 'Callback', {@AllV.SetADC ,[1]});            uimenu(hm,'Label','#2 (Main probe)','Tag','ADCSetButton2', 'Callback', {@AllV.SetADC ,[2]});            uimenu(hm,'Label','#3','Tag','ADCSetButton3', 'Callback', {@AllV.SetADC ,3});            uimenu(hm,'Label','#4','Tag','ADCSetButton1' , 'Callback', {@AllV.SetADC ,4});            uimenu(hm,'Label','#5','Tag','ADCSetButton2', 'Callback', {@AllV.SetADC ,5});        else            uimenu(hm,'Label','#1 (All probes)','Tag','ADCSetButton1' , 'Callback', {@AllV.SetADC ,[1 5]});            uimenu(hm,'Label','#2 (Main probe)','Tag','ADCSetButton2', 'Callback', {@AllV.SetADC ,[2]});            uimenu(hm,'Label','#1 (Other probes)','Tag','ADCSetButton3', 'Callback', {@AllV.SetADC ,3});            uimenu(hm,'Label','#2 (Other probes)','Tag','ADCSetButton3', 'Callback', {@AllV.SetADC ,3});            uimenu(hm,'Label','#3 (Main probe)','Tag','ADCSetButton1' , 'Callback', {@AllV.SetADC ,4});            uimenu(hm,'Label','#4 (Main probe)','Tag','ADCSetButton2', 'Callback', {@AllV.SetADC ,5});        end        uimenu(sm,'Label','Select Probes Plotted','Callback',{@AllV.OptionMenu, 'plottedprobes'});        uimenu(sm,'Label','Keep','Tag','KeepButton','Callback',{@AllV.OptionMenu, 'keepspikes'});        uimenu(sm,'Label','Keep Means','Tag','KeepMeans','Callback',{@AllV.OptionMenu, 'keepmeanspikes'});                        bp = [0.80 0.95 0.1 0.05];        uicontrol(F,'style','check','string','stop','Units','Normalized','Position',bp,'Tag','StopSpool',...            'value',0);        bp = [0.9 0.05 0.1 0.95];        if isfield(PCDATA,'Expt') && isfield(PCDATA.Expt,'Trials')        h = uicontrol(gcf,'Style', 'list',...        'String', num2str([PCDATA.Expt.Trials.Trial]'), 'Tag', 'ChooseTrial','Units','norm', 'Position', bp,'value',1,...        'Max',3,'Min',1,'Callback',@AllV.SelectTrial);        else            disp('Missing PCS Data');        end%        uicontrol(F,'style','pop','string','1|2|3','Units','Normalized','Position',bp,'Tag','ChooseTrial',...%            'Callback', @AllV.SelectTrial);    elseif strcmp(lb,DATA.tag.meanspike)        hm = uimenu(F,'Label','&Options','Tag','MeanSpikeMenu');        uimenu(hm, 'label','Image + Line plot','CallBack', {@AllV.PlotMenu, 'meanmenu' 'image+lines'});        uimenu(hm, 'label','sidebyside','CallBack', {@AllV.PlotMenu, 'meanmenu' 'sidebyside'});        uimenu(hm, 'label','dprime image','CallBack', {@AllV.PlotMenu, 'meanmenu' 'dprimeimage'});        sm = uimenu(hm, 'label','Compare With');        for j = 1:DATA.allnprobes            uimenu(sm, 'label',num2str(j),'CallBack', {@AllV.CompareMean, j});        end        set(F,'UserData',DATA.toplevel);    elseif strcmp(lb,DATA.tag.xcorr)        hm = uimenu(F,'Label','&Plot');        uimenu(hm, 'label','Shape/Efficacy','CallBack', {@AllV.ReplotXcorrs, 'Shape/efficacy'});        sm = uimenu(hm,'Label','&One Pair Type');        uimenu(hm, 'label','&CorssCorr','CallBack', {@AllV.ReplotXcorrs, 'xcorr'});        uimenu(hm, 'label','&Mean Image','CallBack', {@AllV.ReplotXcorrs, 'meanim'});        uimenu(hm, 'label','&Sync Spikes','CallBack', {@AllV.ReplotXcorrs, 'syncspikes'});        uimenu(hm, 'label','&Histograms','CallBack', {@AllV.ReplotXcorrs, 'histograms'});    elseif strcmp(lb,DATA.tag.allxy)        hm = uimenu(F,'Label','Keep', 'callback', @KeepFigure);        set(F,'UserData',DATA.toplevel);            elseif strcmp(lb,DATA.tag.spikes)        hm = uimenu(F,'Label','Keep', 'callback', @KeepFigure);        set(F,'UserData',DATA.toplevel);            elseif isfield(PCDATA,'toplevel');        setappdata(F,'ParentFigure',PCDATA.toplevel);    end    if ~isempty(PCDATA)        SetFigPos(PCDATA,lb);    endend